<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cambiar Contraseña - Medra</title>
    <link rel="icon" href="img/logo-principal/favicon.ico">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { margin: 0; padding: 0; display: flex; flex-direction: column; height: 100vh; background: #f0f2f5; font-family: "Segoe UI", sans-serif; overflow-x: hidden; }
        #outer-container-crear { flex: 1; display: flex; flex-direction: column; padding: 10px; background: #f0f2f5; overflow-y: auto; width: 100%; }
        #content-crear-usuario { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 3px 8px rgba(0,0,0,0.05); max-width: 500px; width: 100%; margin: 0 auto; flex: 1; display: flex; flex-direction: column; overflow-x: hidden; }
        #content-crear-usuario h1 { color: #3A5795; font-size: 24px; margin-bottom: 20px; text-align: center; }
        #changePasswordForm { display: flex; flex-direction: column; gap: 15px; margin-bottom: 20px; }
        .form-group { display: flex; flex-direction: column; }
        .form-group label { font-weight: bold; color: #333; font-size: 12px; margin-bottom: 2px; }
        .input-wrapper { position: relative; }
        .input-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #aaa; font-size: 16px; pointer-events: none; }
        .input-icon::after { content: ''; position: absolute; left: 28px; top: 0; bottom: 0; width: 1px; background-color: #ccc; }
        .form-group input { width: 100%; padding: 8px 8px 8px 45px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 13px; transition: border-color 0.3s ease, box-shadow 0.3s ease; }
        .form-group input:focus { border-color: #3A5795; box-shadow: 0 0 8px rgba(58, 87, 149, 0.5); outline: none; }
        .toggle-password { position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: #aaa; font-size: 16px; cursor: pointer; z-index: 1; }
        .toggle-password:hover { color: #3A5795; }
        .password-requirements { list-style: none; padding: 5px 0 0 0; margin: 5px 0 0 0; font-size: 12px; color: #333; }
        .password-requirements li { display: flex; align-items: center; margin-bottom: 5px; }
        .password-requirements li::before { content: 'X'; display: inline-block; width: 16px; height: 16px; margin-right: 8px; color: #721c24; font-weight: bold; }
        .password-requirements li.valid::before { content: 'Check'; color: #155724; }
        .match-indicator { font-size: 12px; margin-top: 5px; display: flex; align-items: center; }
        .match-indicator::before { content: 'X'; display: inline-block; width: 16px; height: 16px; margin-right: 8px; color: #721c24; font-weight: bold; }
        .match-indicator.valid::before { content: 'Check'; color: #155724; }
        .btn-crear { width: 100%; max-width: 250px; padding: 12px 24px; background-color: #3A5795; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; font-weight: bold; margin: 10px auto 0; align-self: center; }
        .btn-crear:hover:not(:disabled) { background-color: #2a4373; }
        .btn-crear:disabled { background-color: #ccc; cursor: not-allowed; }
        #message { margin-top: 10px; padding: 10px; border-radius: 4px; display: none; font-size: 14px; text-align: center; }
        #message.error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        #message.success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        #message.loading { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        @media (max-width: 768px) { #content-crear-usuario { padding: 15px; } .form-group input { font-size: 12px; } .btn-crear { max-width: 200px; } }
    </style>
</head>
<body>
    <div id="outer-container-crear">
        <div id="content-crear-usuario">
            <h1>Cambiar Contraseña</h1>
            <form id="changePasswordForm">
                <div class="form-group">
                    <label for="newPassword">Nueva Contraseña:</label>
                    <div class="input-wrapper">
                        <i class="fas fa-lock input-icon"></i>
                        <input type="password" id="newPassword" placeholder="Nueva Contraseña" required minlength="8" maxlength="20">
                        <i class="fas fa-eye toggle-password" data-target="newPassword"></i>
                    </div>
                    <ul id="passwordRequirements" class="password-requirements">
                        <li id="req-length" class="invalid">Entre 8 y 20 caracteres</li>
                        <li id="req-uppercase" class="invalid">Al menos una letra mayúscula</li>
                        <li id="req-lowercase" class="invalid">Al menos una letra minúscula</li>
                        <li id="req-number" class="invalid">Al menos un número</li>
                        <li id="req-special" class="invalid">Al menos un carácter especial (!@#$%^&*+-(),.?":{}|<>)</li>
                    </ul>
                </div>
                <div class="form-group">
                    <label for="repeatNewPassword">Repetir Nueva Contraseña:</label>
                    <div class="input-wrapper">
                        <i class="fas fa-lock input-icon"></i>
                        <input type="password" id="repeatNewPassword" placeholder="Repetir Nueva Contraseña" required minlength="8" maxlength="20">
                        <i class="fas fa-eye toggle-password" data-target="repeatNewPassword"></i>
                    </div>
                    <span id="repeatMatch" class="match-indicator invalid">Las contraseñas deben coincidir</span>
                </div>
                <button type="submit" class="btn-crear" id="changeBtn">Cambiar Contraseña</button>
            </form>
            <div id="message"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
        import { getAuth, verifyPasswordResetCode, confirmPasswordReset } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD6JY7FaRqjZoN6OzbFHoIXxd-IJL3H-Ek",
            authDomain: "datara-salud.firebaseapp.com",
            projectId: "datara-salud",
            storageBucket: "datara-salud.firebasestorage.app",
            messagingSenderId: "198886910481",
            appId: "1:198886910481:web:abbc345203a423a6329fb0"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        const urlParams = new URLSearchParams(window.location.search);
        const oobCode = urlParams.get('oobCode');
        const mode = urlParams.get('mode');

        const form = document.getElementById('changePasswordForm');
        const message = document.getElementById('message');
        const changeBtn = document.getElementById('changeBtn');
        const newPasswordInput = document.getElementById('newPassword');
        const repeatNewPasswordInput = document.getElementById('repeatNewPassword');
        const repeatMatchIndicator = document.getElementById('repeatMatch');

        if (!oobCode || mode !== 'resetPassword') {
            showMessage('Enlace inválido.', 'error');
            form.style.display = 'none';
            return;
        }

        // Verificar código
        verifyPasswordResetCode(auth, oobCode).then(email => {
            document.querySelector('h1').textContent = `Cambiar contraseña para: ${email}`;
        }).catch(() => {
            showMessage('Enlace expirado. Solicita uno nuevo.', 'error');
            form.style.display = 'none';
        });

        function validatePassword(p) {
            return {
                length: p.length >= 8 && p.length <= 20,
                uppercase: /[A-Z]/.test(p),
                lowercase: /[a-z]/.test(p),
                number: /[0-9]/.test(p),
                special: /[!@#$%^&*+\-(),.?":{}|<>]/.test(p)
            };
        }

        function updateReqs(p) {
            const v = validatePassword(p);
            ['length','uppercase','lowercase','number','special'].forEach(k => {
                document.getElementById(`req-${k}`).className = v[k] ? 'valid' : 'invalid';
            });
        }

        newPasswordInput.addEventListener('input', () => {
            updateReqs(newPasswordInput.value);
            updateRepeatMatchIndicator();
        });

        repeatNewPasswordInput.addEventListener('input', updateRepeatMatchIndicator);
        function updateRepeatMatchIndicator() {
            const match = newPasswordInput.value === repeatNewPasswordInput.value && newPasswordInput.value;
            repeatMatchIndicator.className = match ? 'valid' : 'invalid';
        }

        document.querySelectorAll('.toggle-password').forEach(t => {
            t.addEventListener('click', () => {
                const input = document.getElementById(t.dataset.target);
                const isPass = input.type === 'password';
                input.type = isPass ? 'text' : 'password';
                t.className = isPass ? 'fas fa-eye-slash toggle-password' : 'fas fa-eye toggle-password';
            });
        });

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const p = newPasswordInput.value;
            if (p !== repeatNewPasswordInput.value) return showMessage('No coinciden.', 'error');
            if (!Object.values(validatePassword(p)).every(x => x)) return showMessage('Cumple todos los requisitos.', 'error');

            changeBtn.disabled = true;
            changeBtn.textContent = 'Cambiando...';
            showMessage('Procesando...', 'loading');

            try {
                await confirmPasswordReset(auth, oobCode, p);
                showMessage('¡Contraseña cambiada!', 'success');
                setTimeout(() => location.href = 'index.html', 2000);
            } catch (err) {
                showMessage('Error: ' + err.message, 'error');
                changeBtn.disabled = false;
                changeBtn.textContent = 'Cambiar Contraseña';
            }
        });

        function showMessage(text, type) {
            message.textContent = text;
            message.className = type;
            message.style.display = 'block';
            if (type !== 'loading') setTimeout(() => message.style.display = 'none', 5000);
        }
    </script>
</body>
</html>