<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Importación de Reportes</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
        import { getAuth, onAuthStateChanged, setPersistence, browserSessionPersistence } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
        import { getFirestore, collection, getDocs, addDoc, query, where, doc, updateDoc } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';
        window.firebaseModules = { initializeApp, getAuth, onAuthStateChanged, setPersistence, browserSessionPersistence, getFirestore, collection, getDocs, addDoc, query, where, doc, updateDoc };
    </script>
    <style>
        html,body{margin:0;padding:0;height:100%;font-family:Arial,sans-serif;background:#f4f4f4;overflow:hidden;font-size:12px}
        .reportes-main-container{width:100%;height:100%;background:white;padding:20px;box-sizing:border-box;display:flex;flex-direction:column}
        .reportes-title{margin:0 0 15px 0;font-size:18px}
        .reportes-controls{display:flex;justify-content:space-between;align-items:end;gap:15px;margin-bottom:15px;flex-wrap:wrap}
        .reportes-filters{display:flex;gap:12px;flex:1;flex-wrap:wrap;align-items:end}
        .reportes-form-group{display:flex;flex-direction:column;min-width:140px}
        .reportes-label{font-size:10px;font-weight:bold;color:#333;margin-bottom:4px}
        input,select{width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;font-size:11px;box-sizing:border-box}
        input:focus,select:focus{outline:none;box-shadow:0 0 0 2px rgba(0,123,255,0.3)}
        .reportes-actions{position:relative}
        #actionsBtn{background:#007bff;color:white;border:none;padding:10px 16px;border-radius:4px;cursor:pointer;font-size:13px;display:flex;align-items:center;gap:8px}
        #actionsBtn:hover{background:#0056b3}
        .reportes-dropdown{display:none;position:absolute;right:0;top:100%;background:white;border:1px solid #ddd;border-radius:4px;box-shadow:0 6px 16px rgba(0,0,0,0.15);z-index:100;min-width:220px;margin-top:4px}
        .reportes-dropdown.show{display:block}
        .reportes-dropdown a{display:block;padding:12px 16px;font-size:12px;color:#333;text-decoration:none;border-bottom:1px solid #eee}
        .reportes-dropdown a:last-child{border-bottom:none}
        .reportes-dropdown a:hover{background:#f8f9fa}
        .table-wrapper{height:700px;overflow:auto;border:1px solid #ddd;border-radius:4px;background:white}
        .reportes-table{width:100%;min-width:2000px;border-collapse:collapse;font-size:11px}
        .reportes-table th,.reportes-table td{padding:6px 4px;border:1px solid #ddd;text-align:left;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        .reportes-table th{background:#f2f2f2;position:relative}
        .reportes-table tbody tr:hover{background:#f8f9fa}
        .resize-handle{position:absolute;right:0;top:0;width:5px;height:100%;cursor:col-resize;background:transparent;z-index:11}
        .resize-handle:hover,.resize-handle.active{background:#007bff}
        .empty-message{text-align:center;padding:80px 0;font-size:14px;color:#666}
        .reportes-loading{display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(255,255,255,0.97);padding:24px;border-radius:8px;box-shadow:0 4px 20px rgba(0,0,0,0.2);z-index:1000;flex-direction:column;align-items:center}
        .reportes-loading.show{display:flex}
        .spinner{width:36px;height:36px;border:4px solid #f0f0f0;border-top:4px solid #007bff;border-radius:50%;animation:s 1s linear infinite;margin-bottom:12px}
        @keyframes s{to{transform:rotate(360deg)}}
        .reportes-toast{position:fixed;top:20px;right:20px;padding:14px 20px;border-radius:6px;color:white;z-index:1001;font-size:13px;transform:translateX(120%);transition:all .4s;opacity:0}
        .reportes-toast.show{transform:translateX(0);opacity:1}
        .reportes-toast.success{background:#28a745}
        .reportes-toast.error{background:#dc3545}
    </style>
</head>
<body>
    <div class="reportes-main-container">
        <h1 class="reportes-title">Importación de Reportes</h1>

        <div class="reportes-controls">
            <div class="reportes-filters">
                <div class="reportes-form-group">
                    <label class="reportes-label">Año</label>
                    <select id="selectAno"></select>
                </div>
                <div class="reportes-form-group">
                    <label class="reportes-label">Mes</label>
                    <select id="selectMes"><option value="">Selecciona mes</option></select>
                </div>
                <div class="reportes-form-group">
                    <label class="reportes-label">Admisión</label>
                    <input type="text" id="buscarAdmision" placeholder="Buscar admisión">
                </div>
                <div class="reportes-form-group">
                    <label class="reportes-label">Paciente</label>
                    <input type="text" id="buscarPaciente" placeholder="Buscar paciente">
                </div>
                <div class="reportes-form-group">
                    <label class="reportes-label">Rut</label>
                    <input type="text" id="buscarRut" placeholder="Buscar rut">
                </div>
                <div class="reportes-form-group">
                    <label class="reportes-label">Descripción</label>
                    <input type="text" id="buscarDescripcion" placeholder="Buscar descripción">
                </div>
                <div class="reportes-form-group">
                    <label class="reportes-label">1° Cirujano</label>
                    <input type="text" id="buscarCirujano" placeholder="Buscar cirujano">
                </div>
            </div>

            <div class="reportes-actions">
                <button id="actionsBtn">
                    Acciones <i class="fas fa-chevron-down"></i>
                </button>
                <div id="actionsMenu" class="reportes-dropdown">
                    <a href="#" id="downloadTemplate">Formato de importación</a>
                    <a href="#" id="importExcel">Importar Excel</a>
                    <a href="#" id="downloadVisible">Descargar visibles</a>
                    <a href="#" id="downloadAll">Descargar todos</a>
                </div>
            </div>
        </div>

        <div class="table-wrapper">
            <table id="reportesTable" class="reportes-table">
                <thead>
                    <tr>
                        <th>Fecha</th><th>Día</th><th>Mes</th><th>Cod. Artículo</th><th>Descripción</th><th>Admisión</th>
                        <th>Rut</th><th>Paciente</th><th>Edad</th><th>Previsión</th><th>Isapre</th><th>Convenio</th>
                        <th>Cód. Arancel</th><th>Arancel</th><th>Cant. Art.</th><th>1° Cirujano</th>
                    </tr>
                </thead>
                <tbody id="reportesBody">
                    <tr><td colspan="16" class="empty-message">Selecciona un mes para cargar los registros</td></tr>
                </tbody>
            </table>
        </div>

        <input type="file" id="fileUpload" style="display:none" accept=".xlsx,.xls">
        <div id="reportes-loading" class="reportes-loading">
            <div class="spinner"></div>
            <div>Procesando importación...</div>
        </div>
        <div id="reportes-toast" class="reportes-toast"></div>
    </div>

    <script type="module">
        const { initializeApp, getAuth, onAuthStateChanged, setPersistence, browserSessionPersistence, getFirestore, collection, getDocs, addDoc, query, where, doc, updateDoc } = window.firebaseModules;
        const firebaseConfig = { apiKey: "AIzaSyD6JY7FaRqjZoN6OzbFHoIXxd-IJL3H-Ek", authDomain: "datara-salud.firebaseapp.com", projectId: "datara-salud", storageBucket: "datara-salud.firebasestorage.app", messagingSenderId: "198886910481", appId: "1:198886910481:web:abbc345203a423a6329fb0" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        setPersistence(auth, browserSessionPersistence);

        let reportes = [], selectedAno = new Date().getFullYear(), selectedMes = '';
        let searchAdmision = '', searchPaciente = '', searchRut = '', searchDesc = '', searchCirujano = '';

        const selectAno = document.getElementById('selectAno');
        const selectMes = document.getElementById('selectMes');
        const body = document.getElementById('reportesBody');
        const loading = document.getElementById('reportes-loading');
        const toast = document.getElementById('reportes-toast');
        const actionsBtn = document.getElementById('actionsBtn');
        const actionsMenu = document.getElementById('actionsMenu');
        const fileInput = document.getElementById('fileUpload');

        function formatDate(d) { if (!d) return ''; const date = new Date(d); return `${String(date.getDate()).padStart(2,'0')}-${String(date.getMonth()+1).padStart(2,'0')}-${date.getFullYear()}`; }
        function showLoading() { loading.classList.add('show'); }
        function hideLoading() { loading.classList.remove('show'); }
        function showToast(m,t='success') { toast.textContent=m; toast.className=`reportes-toast ${t} show`; setTimeout(()=>toast.classList.remove('show'),5000); }

        // === MENÚ ACCIONES ===
        actionsBtn.onclick = (e) => {
            e.stopPropagation();
            actionsMenu.classList.toggle('show');
        };
        document.addEventListener('click', (e) => {
            if (!actionsBtn.contains(e.target) && !actionsMenu.contains(e.target)) {
                actionsMenu.classList.remove('show');
            }
        });

        // === REDIMENSIONAR COLUMNAS ===
        function initResize() { /* ... (el mismo código de antes, lo dejo para no alargar) ... */ 
            const table = document.getElementById('reportesTable');
            const headers = table.querySelectorAll('th');
            let resizing=false, col=-1, startX=0, startW=0;
            const MIN=40, MAX=800;
            function apply() {
                const s = localStorage.getItem('reportes-column-widths');
                if(!s) return;
                try { const w = JSON.parse(s);
                    headers.forEach((th,i)=>{ if(w[i]){ const px=w[i]+'px'; th.style.width=th.style.minWidth=th.style.maxWidth=px;
                        table.querySelectorAll(`td:nth-child(${i+1})`).forEach(td=>td.style.width=td.style.minWidth=td.style.maxWidth=px);
                    }});
                }catch(e){}
            }
            function save() { const w = Array.from(headers).map(th=>parseInt(th.style.width)||th.offsetWidth); localStorage.setItem('reportes-column-widths', JSON.stringify(w)); }
            headers.forEach((th,i)=>{
                let h=th.querySelector('.resize-handle');
                if(!h){ h=document.createElement('div'); h.className='resize-handle'; th.appendChild(h); }
                h.onmousedown=e=>{ e.preventDefault(); resizing=true; col=i; startX=e.clientX; startW=th.offsetWidth; h.classList.add('active'); document.body.style.cursor='col-resize'; document.body.style.userSelect='none'; };
            });
            document.onmousemove=e=>{ if(!resizing||col===-1) return; let nw = Math.max(MIN, Math.min(MAX, startW + (e.clientX-startX))); const px=nw+'px'; headers[col].style.width=headers[col].style.minWidth=headers[col].style.maxWidth=px;
                table.querySelectorAll(`td:nth-child(${col+1})`).forEach(td=>td.style.width=td.style.minWidth=td.style.maxWidth=px); };
            document.onmouseup=()=>{ if(resizing){ resizing=false; col=-1; document.body.style.cursor=''; document.body.style.userSelect=''; table.querySelectorAll('.resize-handle.active').forEach(h=>h.classList.remove('active')); save(); }};
            apply();
        }

        // === CARGA Y FILTROS ===
        async function loadAll() { /* igual que antes */ }
        function updateMeses() { /* igual */ }
        function getVisible() { /* igual */ }
        function render() { /* igual */ }

        // === ACCIONES DEL MENÚ ===
        document.getElementById('downloadTemplate').onclick = e => { e.preventDefault(); downloadTemplate(); actionsMenu.classList.remove('show'); };
        document.getElementById('importExcel').onclick = e => { e.preventDefault(); fileInput.click(); actionsMenu.classList.remove('show'); };
        document.getElementById('downloadVisible').onclick = e => { e.preventDefault(); exportData(getVisible(),'reportes_visibles'); actionsMenu.classList.remove('show'); };
        document.getElementById('downloadAll').onclick = e => { e.preventDefault(); exportData(reportes,'todos_reportes'); actionsMenu.classList.remove('show'); };

        function downloadTemplate(){ /* igual */ }
        function exportData(data,name){ /* igual */ }

        // === IMPORTACIÓN COMPLETA SIN DUPLICADOS ===
        fileInput.onchange = async e => {
            const file = e.target.files[0];
            if (!file) return;
            showLoading();
            try {
                const data = await file.arrayBuffer();
                const wb = XLSX.read(data, {type: 'array', cellDates: true});
                const ws = wb.Sheets[wb.SheetNames[0]];
                const json = XLSX.utils.sheet_to_json(ws, {
                    header: ["fecha","dia","mes","codArticulo","descripcion","admision","rut","paciente","edad","prevision","isapre","convenio","codArancel","arancel","cantidadArticulo","primerCirujano"],
                    range: 1, defval: '', raw: false
                });

                let agregados = 0, actualizados = 0, omitidos = 0;

                for (const r of json) {
                    const fila = {
                        fecha: r.fecha ? formatDate(new Date(r.fecha)) : '',
                        dia: String(r.dia || '').trim(),
                        mes: String(r.mes || '').trim(),
                        codArticulo: String(r.codArticulo || '').trim(),
                        descripcion: String(r.descripcion || '').trim(),
                        admision: String(r.admision || '').trim(),
                        rut: String(r.rut || '').trim(),
                        paciente: String(r.paciente || '').trim(),
                        edad: String(r.edad || '').trim(),
                        prevision: String(r.prevision || '').trim(),
                        isapre: String(r.isapre || '').trim(),
                        convenio: String(r.convenio || '').trim(),
                        codArancel: String(r.codArancel || '').trim(),
                        arancel: String(r.arancel || '').trim(),
                        cantidadArticulo: String(r.cantidadArticulo || '').trim(),
                        primerCirujano: String(r.primerCirujano || '').trim()
                    };

                    if (!fila.admision || !fila.codArticulo) { omitidos++; continue; }

                    const q = query(collection(db, "reportes"), where("admision", "==", fila.admision), where("codArticulo", "==", fila.codArticulo));
                    const snap = await getDocs(q);

                    if (!snap.empty) {
                        const existente = snap.docs[0].data();
                        const hayCambios = Object.keys(fila).some(k => String(fila[k]) !== String(existente[k] || '').trim());
                        if (hayCambios) {
                            await updateDoc(doc(db, "reportes", snap.docs[0].id), {...fila, updatedAt: new Date()});
                            actualizados++;
                        } else omitidos++;
                    } else {
                        await addDoc(collection(db, "reportes"), {...fila, createdAt: new Date()});
                        agregados++;
                    }
                }

                hideLoading();
                showToast(`Importación exitosa: ${agregados} nuevos, ${actualizados} actualizados, ${omitidos} omitidos`, 'success');
                await loadAll();

            } catch (err) {
                hideLoading();
                showToast('Error al importar: ' + err.message, 'error');
                console.error(err);
            }
            fileInput.value = '';
        };

        // === INICIO ===
        onAuthStateChanged(auth, user => {
            if (!user) { window.location.replace('../../../../../../index.html'); return; }
            loadAll();
        });

        document.addEventListener('DOMContentLoaded', initResize);
    </script>
</body>
</html>