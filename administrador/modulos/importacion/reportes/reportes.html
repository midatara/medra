<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Importación de Reportes</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
        import { getAuth, onAuthStateChanged, setPersistence, browserSessionPersistence } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
        import { getFirestore, collection, addDoc, getDocs, query, where, doc, updateDoc } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';
        window.firebaseModules = { initializeApp, getAuth, onAuthStateChanged, setPersistence, browserSessionPersistence, getFirestore, collection, addDoc, getDocs, query, where, doc, updateDoc };
    </script>
    <style>
        html,body{margin:0;padding:0;height:100%;font-family:Arial,sans-serif;background:#f4f4f4;overflow:hidden;font-size:12px}
        .reportes-main-container{width:100%;height:100%;background:white;padding:20px;box-sizing:border-box;display:flex;flex-direction:column}
        .reportes-title{margin:0 0 15px 0;font-size:18px}
        .reportes-controls{display:flex;justify-content:space-between;align-items:end;gap:15px;margin-bottom:15px;flex-wrap:wrap}
        .reportes-filters{display:flex;gap:12px;flex:1;flex-wrap:wrap}
        .reportes-form-group{display:flex;flex-direction:column;min-width:140px}
        .reportes-label{font-size:10px;font-weight:bold;color:#333;margin-bottom:4px}
        input,select{width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;font-size:11px;box-sizing:border-box}
        input:focus,select:focus{outline:none;box-shadow:0 0 0 2px rgba(0,123,255,0.3)}
        .reportes-actions button{background:none;border:none;color:#007bff;cursor:pointer;font-size:13px;padding:8px 12px;display:flex;align-items:center;gap:6px}
        .reportes-actions button:hover{color:#0056b3;text-decoration:underline}
        .reportes-dropdown{display:none;position:absolute;right:0;top:100%;background:white;border:1px solid #ddd;border-radius:4px;box-shadow:0 6px 12px rgba(0,0,0,0.15);z-index:10;min-width:200px}
        .reportes-dropdown a{display:block;padding:10px 16px;font-size:12px;color:#333;text-decoration:none}
        .reportes-dropdown a:hover{background:#f5f5f5}
        .table-wrapper{height:700px;overflow:auto;border:1px solid #ddd;border-radius:4px;background:white}
        .reportes-table{width:100%;min-width:1800px;border-collapse:collapse;font-size:11px}
        .reportes-table th,.reportes-table td{padding:6px 4px;border:1px solid #ddd;text-align:left;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        .reportes-table th{background:#f2f2f2;position:relative}
        .reportes-table tbody tr:hover{background:#f8f9fa}
        .resize-handle{position:absolute;right:0;top:0;width:5px;height:100%;cursor:col-resize;background:transparent;z-index:11;transition:background .2s}
        .resize-handle:hover,.resize-handle.active{background:#007bff}
        .empty-message{text-align:center;padding:60px;font-size:14px;color:#666}
        .reportes-loading{display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(255,255,255,0.95);padding:20px;border-radius:8px;box-shadow:0 4px 20px rgba(0,0,0,0.2);z-index:1000}
        .reportes-loading.show{display:block}
        .spinner{width:32px;height:32px;border:4px solid #f0f0f0;border-top:4px solid #007bff;border-radius:50%;animation:s 1s linear infinite;margin-bottom:10px}
        @keyframes s{to{transform:rotate(360deg)}}
        .reportes-toast{position:fixed;top:20px;right:20px;padding:12px 20px;border-radius:6px;color:white;z-index:1001;font-size:12px;transform:translateX(100%);transition:transform .4s,opacity .4s;opacity:0}
        .reportes-toast.show{transform:translateX(0);opacity:1}
        .reportes-toast.success{background:#28d4edda;border:1px solid #c3e6cb}
        .reportes-toast.error{background:#f8d7da;border:1px solid #f5c6cb;color:#721c24}
    </style>
</head>
<body>
    <div class="reportes-main-container">
        <h1 class="reportes-title">Importación de Reportes</h1>

        <div class="reportes-controls">
            <div class="reportes-filters">
                <div class="reportes-form-group">
                    <label class="reportes-label">Año</label>
                    <select id="selectAno"></select>
                </div>
                <div class="reportes-form-group">
                    <label class="reportes-label">Mes</label>
                    <select id="selectMes"><option value="">Selecciona mes</option></select>
                </div>
                <div class="reportes-form-group">
                    <label class="reportes-label">Admisión</label>
                    <input type="text" id="buscarAdmision" placeholder="Buscar admisión">
                </div>
                <div class="reportes-form-group">
                    <label class="reportes-label">Paciente</label>
                    <input type="text" id="buscarPaciente" placeholder="Buscar paciente">
                </div>
                <div class="reportes-form-group">
                    <label class="reportes-label">Rut</label>
                    <input type="text" id="buscarRut" placeholder="Buscar rut">
                </div>
                <div class="reportes-form-group">
                    <label class="reportes-label">Descripción</label>
                    <input type="text" id="buscarDescripcion" placeholder="Buscar descripción">
                </div>
                <div class="reportes-form-group">
                    <label class="reportes-label">1° Cirujano</label>
                    <input type="text" id="buscarCirujano" placeholder="Buscar cirujano">
                </div>
            </div>
            <div class="reportes-actions">
                <button id="actionsBtn">Acciones</button>
                <div id="actionsMenu" class="reportes-dropdown">
                    <a href="#" id="downloadTemplate">Formato de importación</a>
                    <a href="#" id="importExcel">Importar Excel</a>
                    <a href="#" id="downloadVisible">Descargar visibles</a>
                    <a href="#" id="downloadAll">Descargar todos</a>
                </div>
            </div>
        </div>

        <div class="table-wrapper">
            <table id="reportesTable" class="reportes-table">
                <thead>
                    <tr>
                        <th>Fecha</th>
                        <th>Día</th>
                        <th>Mes</th>
                        <th>Cod. Artículo</th>
                        <th>Descripción</th>
                        <th>Admisión</th>
                        <th>Rut</th>
                        <th>Paciente</th>
                        <th>Edad</th>
                        <th>Previsión</th>
                        <th>Isapre</th>
                        <th>Convenio</th>
                        <th>Cód. Arancel</th>
                        <th>Arancel</th>
                        <th>Cant. Art.</th>
                        <th>1° Cirujano</th>
                    </tr>
                </thead>
                <tbody id="reportesBody">
                    <tr><td colspan="16" class="empty-message">Selecciona un mes para cargar los registros</td></tr>
                </tbody>
            </table>
        </div>

        <input type="file" id="fileUpload" style="display:none" accept=".xlsx,.xls">
        <div id="reportes-loading" class="reportes-loading">
            <div class="spinner"></div>
            <div>Cargando...</div>
        </div>
        <div id="reportes-toast" class="reportes-toast"></div>
    </div>

    <script type="module">
        const { initializeApp, getAuth, onAuthStateChanged, setPersistence, browserSessionPersistence, getFirestore, collection, getDocs, addDoc, query, where, doc, updateDoc } = window.firebaseModules;
        const firebaseConfig = { apiKey: "AIzaSyD6JY7FaRqjZoN6OzbFHoIXxd-IJL3H-Ek", authDomain: "datara-salud.firebaseapp.com", projectId: "datara-salud", storageBucket: "datara-salud.firebasestorage.app", messagingSenderId: "198886910481", appId: "1:198886910481:web:abbc345203a423a6329fb0" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        setPersistence(auth, browserSessionPersistence);

        let reportes = [], selectedAno = new Date().getFullYear(), selectedMes = '';
        let searchAdmision = '', searchPaciente = '', searchRut = '', searchDesc = '', searchCirujano = '';

        const selectAno = document.getElementById('selectAno');
        const selectMes = document.getElementById('selectMes');
        const body = document.getElementById('reportesBody');
        const loading = document.getElementById('reportes-loading');
        const toast = document.getElementById('reportes-toast');
        const actionsBtn = document.getElementById('actionsBtn');
        const actionsMenu = document.getElementById('actionsMenu');
        const fileInput = document.getElementById('fileUpload');

        function formatDate(d) { if (!d) return ''; const date = new Date(d); return `${String(date.getDate()).padStart(2,'0')}-${String(date.getMonth()+1).padStart(2,'0')}-${date.getFullYear()}`; }
        function showLoading() { loading.classList.add('show'); }
        function hideLoading() { loading.classList.remove('show'); }
        function showToast(m,t='success') { toast.textContent=m; toast.className=`reportes-toast ${t} show`; setTimeout(()=>toast.classList.remove('show'),4000); }

        function initResize() {
            const table = document.getElementById('reportesTable');
            const headers = table.querySelectorAll('th');
            let resizing=false, col=-1, startX=0, startW=0;
            const MIN=40, MAX=800;

            function apply() {
                const s = localStorage.getItem('reportes-column-widths');
                if(!s) return;
                try {
                    const w = JSON.parse(s);
                    headers.forEach((th,i)=>{
                        if(w[i]){
                            const px=w[i]+'px';
                            th.style.width=th.style.minWidth=th.style.maxWidth=px;
                            table.querySelectorAll(`td:nth-child(${i+1})`).forEach(td=>td.style.width=td.style.minWidth=td.style.maxWidth=px);
                        }
                    });
                }catch(e){}
            }
            function save() {
                const w = Array.from(headers).map(th=>parseInt(th.style.width)||th.offsetWidth);
                localStorage.setItem('reportes-column-widths', JSON.stringify(w));
            }
            headers.forEach((th,i)=>{
                let h=th.querySelector('.resize-handle');
                if(!h){ h=document.createElement('div'); h.className='resize-handle'; th.appendChild(h); }
                h.onmousedown=e=>{ e.preventDefault(); resizing=true; col=i; startX=e.clientX; startW=th.offsetWidth; h.classList.add('active'); document.body.style.cursor='col-resize'; document.body.style.userSelect='none'; };
            });
            document.onmousemove=e=>{
                if(!resizing||col===-1) return;
                let nw = Math.max(MIN, Math.min(MAX, startW + (e.clientX-startX)));
                const px=nw+'px';
                headers[col].style.width=headers[col].style.minWidth=headers[col].style.maxWidth=px;
                table.querySelectorAll(`td:nth-child(${col+1})`).forEach(td=>td.style.width=td.style.minWidth=td.style.maxWidth=px);
            };
            document.onmouseup=()=>{
                if(resizing){
                    resizing=false; col=-1;
                    document.body.style.cursor=''; document.body.style.userSelect='';
                    table.querySelectorAll('.resize-handle.active').forEach(h=>h.classList.remove('active'));
                    save();
                }
            };
            apply();
        }

        async function loadAll() {
            showLoading();
            const snap = await getDocs(collection(db,'reportes'));
            reportes = snap.docs.map(d=>({id:d.id,...d.data()}));
            const anos = [...new Set(reportes.map(r=>new Date(r.fecha).getFullYear()))].sort((a,b)=>b-a);
            selectAno.innerHTML = anos.map(a=>`<option value="${a}">${a}</option>`).join('');
            selectAno.value = selectedAno;
            updateMeses();
            hideLoading();
        }

        function updateMeses() {
            const meses = new Set();
            reportes.forEach(r=>{
                const d=new Date(r.fecha);
                if(d.getFullYear()==selectedAno) meses.add(d.toLocaleString('es-CL',{month:'long'}));
            });
            const orden = ['enero','febrero','marzo','abril','mayo','junio','julio','agosto','septiembre','octubre','noviembre','diciembre'];
            const sorted = [...meses].sort((a,b)=>orden.indexOf(a)-orden.indexOf(b));
            selectMes.innerHTML = '<option value="">Selecciona mes</option>' + sorted.map(m=>`<option value="${m}">${m.charAt(0).toUpperCase()+m.slice(1)}</option>`).join('');
            selectedMes = '';
            render();
        }

        function getVisible() {
            if(!selectedMes) return [];
            return reportes.filter(r=>{
                const d=new Date(r.fecha);
                if(d.getFullYear()!=selectedAno || d.toLocaleString('es-CL',{month:'long'})!==selectedMes) return false;
                const a=(r.admision||'').toLowerCase().includes(searchAdmision);
                const p=(r.paciente||'').toLowerCase().includes(searchPaciente);
                const ru=(r.rut||'').toLowerCase().includes(searchRut);
                const de=(r.descripcion||'').toLowerCase().includes(searchDesc);
                const c=(r.primerCirujano||'').toLowerCase().includes(searchCirujano);
                return a&&p&&ru&&de&&c;
            });
        }

        function render() {
            body.innerHTML = '';
            if(!selectedMes){
                body.innerHTML = '<tr><td colspan="16" class="empty-message">Selecciona un mes para cargar los registros</td></tr>';
                return;
            }
            const data = getVisible();
            if(data.length===0){
                body.innerHTML = '<tr><td colspan="16" class="empty-message">No hay resultados</td></tr>';
                return;
            }
            data.forEach(r=>{
                const tr=document.createElement('tr');
                tr.innerHTML=`
                    <td>${formatDate(r.fecha)}</td>
                    <td>${r.dia||''}</td>
                    <td>${r.mes||''}</td>
                    <td>${r.codArticulo||''}</td>
                    <td>${r.descripcion||''}</td>
                    <td>${r.admision||''}</td>
                    <td>${r.rut||''}</td>
                    <td>${r.paciente||''}</td>
                    <td>${r.edad||''}</td>
                    <td>${r.prevision||''}</td>
                    <td>${r.isapre||''}</td>
                    <td>${r.convenio||''}</td>
                    <td>${r.codArancel||''}</td>
                    <td>${r.arancel||''}</td>
                    <td>${r.cantidadArticulo||''}</td>
                    <td>${r.primerCirujano||''}</td>
                `;
                body.appendChild(tr);
            });
            setTimeout(initResize,50);
        }

        selectAno.onchange = () => { selectedAno = selectAno.value; updateMeses(); };
        selectMes.onchange = () => { selectedMes = selectMes.value; render(); };

        ['buscarAdmision','buscarPaciente','buscarRut','buscarDescripcion','buscarCirujano'].forEach(id=>{
            document.getElementById(id).oninput = e=>{
                const v = e.target.value.toLowerCase().trim();
                if(id==='buscarAdmision') searchAdmision=v;
                if(id==='buscarPaciente') searchPaciente=v;
                if(id==='buscarRut') searchRut=v;
                if(id==='buscarDescripcion') searchDesc=v;
                if(id==='buscarCirujano') searchCirujano=v;
                if(selectedMes) render();
            };
        });

        actionsBtn.onclick = () => actionsMenu.style.display = actionsMenu.style.display==='block'?'none':'block';
        window.onclick = e => { if(!actionsBtn.contains(e.target)&&!actionsMenu.contains(e.target)) actionsMenu.style.display='none'; };

        document.getElementById('downloadTemplate').onclick = e=>{e.preventDefault();downloadTemplate();};
        document.getElementById('importExcel').onclick = e=>{e.preventDefault();fileInput.click();};
        document.getElementById('downloadVisible').onclick = e=>{e.preventDefault();exportData(getVisible(),'reportes_visibles');};
        document.getElementById('downloadAll').onclick = e=>{e.preventDefault();exportData(reportes,'todos_reportes');};

        function downloadTemplate(){
            const ws = XLSX.utils.aoa_to_sheet([["Fecha","Día","Mes","Cod. Artículo","Descripción","Admisión","Rut","Paciente","Edad","Previsión","Isapre","Convenio","Cód. Arancel","Arancel","Cant. Art.","1° Cirujano"]]);
            const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,"Template");
            XLSX.writeFile(wb,"template_reportes.xlsx");
        }

        function exportData(data,name){
            const exp = data.map(r=>({
                fecha:formatDate(r.fecha),dia:r.dia,mes:r.mes,codArticulo:r.codArticulo,
                descripcion:r.descripcion,admision:r.admision,rut:r.rut,paciente:r.paciente,
                edad:r.edad,prevision:r.prevision,isapre:r.isapre,convenio:r.convenio,
                codArancel:r.codArancel,arancel:r.arancel,cantidadArticulo:r.cantidadArticulo,
                primerCirujano:r.primerCirujano
            }));
            const ws = XLSX.utils.json_to_sheet(exp);
            const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,"Reportes");
            XLSX.writeFile(wb, name+'.xlsx');
        }

        fileInput.onchange = async e=>{
            const f=e.target.files[0];
            if(!f) return;
            showLoading();
            try{
                const data = await f.arrayBuffer();
                const wb = XLSX.read(data,{type:'array',cellDates:true});
                const ws = wb.Sheets[wb.SheetNames[0]];
                const json = XLSX.utils.sheet_to_json(ws,{header:1,range:1});
                showToast(`Archivo cargado: ${json.length} filas detectadas`,'success');
                // Aquí puedes volver a poner toda la lógica de importación si la necesitas
            }catch(err){showToast('Error al leer archivo','error');}
            hideLoading();
            fileInput.value='';
        };

        onAuthStateChanged(auth, user=>{
            if(!user){ window.location.replace('../../../../../../index.html'); return; }
            loadAll();
        });

        document.addEventListener('DOMContentLoaded', initResize);
    </script>
</body>
</html>