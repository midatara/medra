<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Importación de Reportes</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
        import { getAuth, onAuthStateChanged, setPersistence, browserSessionPersistence } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
        import { getFirestore, collection, addDoc, getDocs, query, where, doc, updateDoc } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';
        window.firebaseModules = { initializeApp, getAuth, onAuthStateChanged, setPersistence, browserSessionPersistence, getFirestore, collection, addDoc, getDocs, query, where, doc, updateDoc };
    </script>
    <style>
        html, body {margin:0;padding:0;height:100%;font-family:Arial,sans-serif;background:#f4f4f4;overflow:hidden;font-size:12px}
        .reportes-main-container{width:100%;height:100%;background:white;padding:5px 20px 20px 20px;box-sizing:border-box;overflow-y:auto;border-radius:8px;box-shadow:0 0 10px rgba(0,0,0,0.1);position:relative}
        .reportes-title{text-align:start;margin:0 0 15px 0;font-size:18px}
        .reportes-fields-container{display:flex;justify-content:space-between;gap:10px;margin-bottom:20px;align-items:center}
        .reportes-search-section{display:flex;flex-direction:row;gap:20px;flex:1}
        .reportes-form-group{display:flex;flex-direction:column;align-items:flex-start;gap:4px;flex:1;min-width:0;max-width:200px}
        .reportes-label{font-size:10px;font-weight:bold;color:#333;white-space:nowrap}
        #buscarAdmision,#buscarPaciente,#buscarRut,#buscarDescripcion,#buscarPrimerCirujano,#selectAno,#selectMes,#selectDia{width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;font-size:11px;box-sizing:border-box}
        #buscarAdmision:focus,#buscarPaciente:focus,#buscarRut:focus,#buscarDescripcion:focus,#buscarPrimerCirujano:focus,#selectAno:focus,#selectMes:focus,#selectDia:focus{box-shadow:0 0 12px rgba(0,123,255,0.5);outline:none}
        .reportes-actions-menu{position:relative;text-align:right}
        #actionsBtn{background:none;border:none;color:#007bff;cursor:pointer;font-size:12px;padding:8px 16px;display:inline-flex;align-items:center;gap:5px}
        #actionsBtn:hover{color:#0056b3;text-decoration:underline}
        .reportes-dropdown-menu{display:none;position:absolute;left:calc(-250px+20px);top:100%;background:white;min-width:250px;box-shadow:2px 8px 16px rgba(0,0,0,0.2);z-index:1;border-radius:4px;overflow:hidden;flex-direction:column}
        .reportes-dropdown-menu .menu-title{color:#333;padding:12px 16px;font-size:12px;font-weight:bold;background:#f2f2f2;display:flex;align-items:center;gap:5px}
        .reportes-dropdown-menu a{color:black;padding:12px 16px;text-decoration:none;display:block;font-size:12px;text-align:left;overflow-wrap:break-word}
        .reportes-dropdown-menu a:hover{background:#f1f1f1}
        .reportes-table-container{width:100%;overflow-x:auto;margin-bottom:20px}
        .reportes-table{width:100%;border-collapse:collapse;font-size:11px;border:1px solid #ddd;table-layout:fixed}
        .reportes-table th,.reportes-table td{padding:4px;text-align:left;border:1px solid #ddd;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        .reportes-table th{background:#f2f2f2;font-size:11px;position:relative}
        .reportes-table th:nth-child(1),.reportes-table td:nth-child(1){width:100px;min-width:80px;max-width:100px}
        .reportes-table th:nth-child(2),.reportes-table td:nth-child(2){width:80px;min-width:60px;max-width:80px}
        .reportes-table th:nth-child(3),.reportes-table td:nth-child(3){width:100px;min-width:80px;max-width:100px}
        .reportes-table th:nth-child(4),.reportes-table td:nth-child(4){width:120px;min-width:80px;max-width:120px}
        .reportes-table th:nth-child(5),.reportes-table td:nth-child(5){width:300px;min-width:200px;max-width:300px}
        .reportes-table th:nth-child(6),.reportes-table td:nth-child(6){width:120px;min-width:80px;max-width:120px}
        .reportes-table th:nth-child(7),.reportes-table td:nth-child(7){width:120px;min-width:100px;max-width:120px}
        .reportes-table th:nth-child(8),.reportes-table td:nth-child(8){width:200px;min-width:150px;max-width:200px}
        .reportes-table th:nth-child(9),.reportes-table td:nth-child(9){width:80px;min-width:60px;max-width:80px}
        .reportes-table th:nth-child(10),.reportes-table td:nth-child(10){width:100px;min-width:80px;max-width:100px}
        .reportes-table th:nth-child(11),.reportes-table td:nth-child(11){width:120px;min-width:100px;max-width:120px}
        .reportes-table th:nth-child(12),.reportes-table td:nth-child(12){width:100px;min-width:80px;max-width:100px}
        .reportes-table th:nth-child(13),.reportes-table td:nth-child(13){width:120px;min-width:80px;max-width:120px}
        .reportes-table th:nth-child(14),.reportes-table td:nth-child(14){width:120px;min-width:100px;max-width:120px}
        .reportes-table th:nth-child(15),.reportes-table td:nth-child(15){width:100px;min-width:60px;max-width:100px}
        .reportes-table th:nth-child(16),.reportes-table td:nth-child(16){width:200px;min-width:150px;max-width:200px}
        .reportes-table tbody tr:hover{background:#f8f9fa}
        .resize-handle{position:absolute;right:0;top:0;width:5px;height:100%;cursor:col-resize;background:transparent;z-index:11;transition:background .2s}
        .resize-handle:hover,.resize-handle.active{background:#007bff}
        .reportes-pagination{display:flex;justify-content:space-between;align-items:center;padding:10px;background:#f8f9fa;border-radius:4px;flex-wrap:nowrap}
        .reportes-pagination-info{font-size:11px;flex:1;text-align:left}
        .reportes-pagination-controls{display:flex;align-items:center;gap:5px;flex-shrink:0}
        .reportes-pagination-controls button{padding:6px 10px;background:#007bff;color:white;border:none;border-radius:4px;cursor:pointer;font-size:11px}
        .reportes-pagination-controls button:hover:not(:disabled){background:#0056b3}
        .reportes-pagination-controls button:disabled{background:#ccc;cursor:not-allowed}
        .reportes-page-numbers{display:flex;gap:5px;align-items:center}
        .reportes-page-numbers button{padding:4px 8px;border:1px solid #ddd;background:white;cursor:pointer;font-size:11px;border-radius:4px}
        .reportes-page-numbers button.active{background:#007bff;color:white;border-color:#007bff}
        .reportes-page-numbers button:hover:not(.active){background:#f0f0f0}
        .reportes-page-numbers .reportes-dots{padding:4px;cursor:default;font-size:11px;line-height:1.5}
        #reportes-message{margin-bottom:20px;padding:8px;border-radius:4px;display:none;font-size:11px}
        .reportes-message-error{background:#f8d7da;color:#721c24;border:1px solid #f5c6cb}
        .reportes-message-success{background:#d4edda;color:#155724;border:1px solid #c3e6cb}
        .reportes-loading{display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);width:120px;height:80px;background:rgba(255,255,255,0.95);border-radius:8px;box-shadow:0 4px 20px rgba(0,0,0,0.2);z-index:1000;justify-content:center;align-items:center;flex-direction:column;padding:16px;backdrop-filter:blur(8px)}
        .reportes-loading.show{display:flex}
        .reportes-loading-spinner{width:32px;height:32px;border:3px solid #e3f2fd;border-top:3px solid #007bff;border-radius:50%;animation:spin 1s linear infinite;margin-bottom:8px}
        .reportes-loading-text{font-size:12px;color:#333;font-weight:500;text-align:center}
        .reportes-import-progress{display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);width:300px;background:rgba(255,255,255,0.95);border-radius:8px;box-shadow:0 4px 20px rgba(0,0,0,0.2);z-index:1000;padding:20px;backdrop-filter:blur(8px)}
        .reportes-import-progress.show{display:block}
        .reportes-progress-bar-container{width:100%;height:20px;background:#e3f2fd;border-radius:10px;overflow:hidden;margin-bottom:10px}
        .reportes-progress-bar{height:100%;background:#007bff;width:0%;transition:width .3s ease}
        .reportes-progress-text{font-size:12px;color:#333;font-weight:500;text-align:center}
        @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
        .reportes-toast{position:fixed;top:20px;right:20px;background:#d4edda;color:#155724;padding:12px 20px;border-radius:6px;border:1px solid #c3e6cb;font-size:12px;z-index:1001;max-width:300px;box-shadow:0 4px 12px rgba(0,0,0,0.15);opacity:0;transform:translateX(100%);transition:opacity .3s,transform .3s}
        .reportes-toast.show{opacity:1;transform:translateX(0)}
        .reportes-toast.error{background:#f8d7da;color:#721c24;border:1px solid #f5c6cb}
        .modal{display:none;position:fixed;z-index:1002;left:0;top:0;width:100%;height:100%;overflow:auto;background:rgba(0,0,0,0.4)}
        .modal-content{background:#fefefe;margin:15% auto;padding:20px;border:1px solid #888;width:80%;max-width:500px;border-radius:8px;box-shadow:0 4px 20px rgba(0,0,0,0.3)}
        .close{color:#aaa;float:right;font-size:28px;font-weight:bold;cursor:pointer}
        .close:hover,.close:focus{color:black;text-decoration:none}
        .modal-form-group{display:flex;flex-direction:column;margin-bottom:15px}
        .modal-form-group label{font-size:12px;font-weight:bold;margin-bottom:5px}
        .modal-form-group select{padding:8px;border:1px solid #ddd;border-radius:4px;font-size:11px}
        .modal-buttons{display:flex;justify-content:flex-end;gap:10px;margin-top:20px}
        .modal-btn{padding:8px 16px;border:none;border-radius:4px;cursor:pointer;font-size:12px}
        .modal-btn-primary{background:#007bff;color:white}
        .modal-btn-secondary{background:#6c757d;color:white}
        @media (max-width:768px){
            .reportes-fields-container{flex-direction:column;gap:20px}
            .reportes-search-section{flex-direction:column;gap:15px}
            .reportes-form-group{max-width:none}
            .reportes-toast{top:10px;right:10px;left:10px;max-width:none}
            .reportes-loading{width:100px;height:70px;padding:12px}
            .reportes-loading-spinner{width:28px;height:28px}
            .reportes-import-progress{width:90%;max-width:280px;padding:15px}
            .modal-content{width:90%;margin:20% auto}
            .reportes-pagination{flex-direction:row;align-items:center;gap:10px}
            .reportes-pagination-info{font-size:10px}
            .reportes-pagination-controls button{padding:4px 8px;font-size:10px}
            .reportes-page-numbers button{padding:3px 6px;font-size:10px}
            .reportes-dropdown-menu{min-width:200px;left:calc(-200px+20px)}
        }
    </style>
</head>
<body>
    <div class="reportes-main-container">
        <h1 class="reportes-title">Importación de Reportes</h1>
        <div id="reportes-message"></div>
        <div class="reportes-fields-container">
            <div class="reportes-search-section">
                <div class="reportes-form-group">
                    <label for="buscarAdmision" class="reportes-label">Buscar Admisión:</label>
                    <input type="text" id="buscarAdmision" placeholder="Buscar por admisión" autocomplete="off">
                </div>
                <div class="reportes-form-group">
                    <label for="buscarPaciente" class="reportes-label">Buscar Paciente:</label>
                    <input type="text" id="buscarPaciente" placeholder="Buscar por paciente" autocomplete="off">
                </div>
                <div class="reportes-form-group">
                    <label for="buscarRut" class="reportes-label">Buscar Rut:</label>
                    <input type="text" id="buscarRut" placeholder="Buscar por rut" autocomplete="off">
                </div>
                <div class="reportes-form-group">
                    <label for="buscarDescripcion" class="reportes-label">Buscar Descripción:</label>
                    <input type="text" id="buscarDescripcion" placeholder="Buscar por descripción" autocomplete="off">
                </div>
                <div class="reportes-form-group">
                    <label for="buscarPrimerCirujano" class="reportes-label">Buscar 1° Cirujano:</label>
                    <input type="text" id="buscarPrimerCirujano" placeholder="Buscar por 1° cirujano" autocomplete="off">
                </div>
                <div class="reportes-form-group">
                    <label for="selectAno" class="reportes-label">Año:</label>
                    <select id="selectAno"></select>
                </div>
                <div class="reportes-form-group">
                    <label for="selectMes" class="reportes-label">Mes:</label>
                    <select id="selectMes"></select>
                </div>
                <div class="reportes-form-group">
                    <label for="selectDia" class="reportes-label">Día:</label>
                    <select id="selectDia"></select>
                </div>
            </div>
            <div class="reportes-actions-menu">
                <button id="actionsBtn">Acciones</button>
                <div id="actionsMenu" class="reportes-dropdown-menu">
                    <div class="menu-title">Acciones</div>
                    <a href="#" id="downloadTemplate">Formato de importación</a>
                    <a href="#" id="importExcel">Importar Excel</a>
                    <a href="#" id="downloadAll">Descargar todos los registros</a>
                    <a href="#" id="downloadPage">Descargar página actual</a>
                    <a href="#" id="downloadMes">Descargar mes</a>
                </div>
            </div>
        </div>
        <div class="reportes-table-container">
            <table id="reportesTable" class="reportes-table">
                <thead>
                    <tr>
                        <th>Fecha</th>
                        <th>Día</th>
                        <th>Mes</th>
                        <th>Cod. Artículo</th>
                        <th>Descripción</th>
                        <th>Admisión</th>
                        <th>Rut</th>
                        <th>Paciente</th>
                        <th>Edad</th>
                        <th>Previsión</th>
                        <th>Isapre</th>
                        <th>Convenio</th>
                        <th>Cód. Arancel</th>
                        <th>Arancel</th>
                        <th>Cant. Art.</th>
                        <th>1° Cirujano</th>
                    </tr>
                </thead>
                <tbody id="reportesBody"></tbody>
            </table>
        </div>
        <div class="reportes-pagination" id="pagination">
            <div class="reportes-pagination-info" id="paginationInfo"></div>
            <div class="reportes-pagination-controls">
                <button id="prevBtn">Anterior</button>
                <div class="reportes-page-numbers" id="pageNumbers"></div>
                <button id="nextBtn">Siguiente</button>
            </div>
        </div>
        <input type="file" id="fileUpload" style="display:none;" accept=".xlsx,.xls">
        <div id="reportes-loading" class="reportes-loading">
            <div class="reportes-loading-spinner"></div>
            <div class="reportes-loading-text">Procesando...</div>
        </div>
        <div id="reportes-import-progress" class="reportes-import-progress">
            <div class="reportes-progress-bar-container">
                <div id="progressBar" class="reportes-progress-bar"></div>
            </div>
            <div id="progressText" class="reportes-progress-text">Importando: 0%</div>
        </div>
        <div id="reportes-toast" class="reportes-toast"></div>
    </div>

    <div id="downloadMesModal" class="modal">
        <div class="modal-content">
            <span class="close" id="closeDownloadMes">x</span>
            <h2>Descargar por Mes</h2>
            <div class="modal-form-group">
                <label for="selectDownloadAno">Año:</label>
                <select id="selectDownloadAno"></select>
            </div>
            <div class="modal-form-group">
                <label for="selectDownloadMes">Mes:</label>
                <select id="selectDownloadMes"></select>
            </div>
            <div class="modal-buttons">
                <button type="button" class="modal-btn modal-btn-secondary" id="cancelDownloadMes">Cancelar</button>
                <button type="button" class="modal-btn modal-btn-primary" id="confirmDownloadMes">Descargar</button>
            </div>
        </div>
    </div>

    <script type="module">
        const { initializeApp, getAuth, onAuthStateChanged, setPersistence, browserSessionPersistence, getFirestore, collection, addDoc, getDocs, query, where, doc, updateDoc } = window.firebaseModules;
        const firebaseConfig = {
            apiKey: "AIzaSyD6JY7FaRqjZoN6OzbFHoIXxd-IJL3H-Ek",
            authDomain: "datara-salud.firebaseapp.com",
            projectId: "datara-salud",
            storageBucket: "datara-salud.firebasestorage.app",
            messagingSenderId: "198886910481",
            appId: "1:198886910481:web:abbc345203a423a6329fb0",
            measurementId: "G-MLYVTZPPLD"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        setPersistence(auth, browserSessionPersistence);

        let reportes = [], currentPage = 1, PAGE_SIZE = 10;
        let searchAdmision = '', searchPaciente = '', searchRut = '', searchDescripcion = '', searchPrimerCirujano = '';
        let selectedAno = new Date().getFullYear(), selectedMes = '', selectedDia = '';
        let anos = [], mesesPorAno = {}, diasPorMesAno = {};

        function formatDateToDDMMYYYY(date) {
            if (!date || isNaN(new Date(date))) return '';
            const d = new Date(date);
            return `${String(d.getDate()).padStart(2,'0')}-${String(d.getMonth()+1).padStart(2,'0')}-${d.getFullYear()}`;
        }

        function initColumnResizing() {
            const table = document.getElementById('reportesTable');
            if (!table) return;
            const headers = Array.from(table.querySelectorAll('th'));
            let isResizing = false, currentCol = -1, startX = 0, startWidth = 0;
            const MIN_WIDTH = 40, MAX_WIDTH = 800;

            function applySavedWidths() {
                const saved = localStorage.getItem('reportes-column-widths');
                if (!saved) return;
                try {
                    const widths = JSON.parse(saved);
                    headers.forEach((th, i) => {
                        if (widths[i]) {
                            const w = widths[i];
                            th.style.width = th.style.minWidth = th.style.maxWidth = `${w}px`;
                            table.querySelectorAll(`tbody td:nth-child(${i+1})`).forEach(td => {
                                td.style.width = td.style.minWidth = td.style.maxWidth = `${w}px`;
                            });
                        }
                    });
                } catch(e) {}
            }

            function saveWidths() {
                const widths = headers.map(th => parseInt(th.style.width) || th.offsetWidth);
                localStorage.setItem('reportes-column-widths', JSON.stringify(widths));
            }

            headers.forEach((th, i) => {
                let handle = th.querySelector('.resize-handle');
                if (!handle) {
                    handle = document.createElement('div');
                    handle.className = 'resize-handle';
                    th.appendChild(handle);
                }
                handle.addEventListener('mousedown', e => {
                    e.preventDefault(); e.stopPropagation();
                    isResizing = true; currentCol = i; startX = e.clientX; startWidth = th.offsetWidth;
                    handle.classList.add('active');
                    document.body.style.cursor = 'col-resize';
                    document.body.style.userSelect = 'none';
                });
            });

            document.addEventListener('mousemove', e => {
                if (!isResizing || currentCol === -1) return;
                const delta = e.clientX - startX;
                let newW = Math.max(MIN_WIDTH, Math.min(MAX_WIDTH, startWidth + delta));
                const th = headers[currentCol];
                th.style.width = th.style.minWidth = th.style.maxWidth = `${newW}px`;
                table.querySelectorAll(`tbody td:nth-child(${currentCol+1})`).forEach(td => {
                    td.style.width = td.style.minWidth = td.style.maxWidth = `${newW}px`;
                });
            });

            document.addEventListener('mouseup', () => {
                if (isResizing) {
                    isResizing = false; currentCol = -1;
                    document.body.style.cursor = ''; document.body.style.userSelect = '';
                    table.querySelectorAll('.resize-handle.active').forEach(h => h.classList.remove('active'));
                    saveWidths();
                }
            });

            applySavedWidths();
            const originalRender = window.renderTable || renderTable;
            window.renderTable = (...args) => {
                originalRender.apply(this, args);
                setTimeout(applySavedWidths, 50);
            };
        }

        document.addEventListener('DOMContentLoaded', () => {
            const loading = document.getElementById('reportes-loading');
            const importProgress = document.getElementById('reportes-import-progress');
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            const toast = document.getElementById('reportes-toast');
            const reportesBody = document.getElementById('reportesBody');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const pageNumbers = document.getElementById('pageNumbers');
            const paginationInfo = document.getElementById('paginationInfo');
            const buscarAdmisionInput = document.getElementById('buscarAdmision');
            const buscarPacienteInput = document.getElementById('buscarPaciente');
            const buscarRutInput = document.getElementById('buscarRut');
            const buscarDescripcionInput = document.getElementById('buscarDescripcion');
            const buscarPrimerCirujanoInput = document.getElementById('buscarPrimerCirujano');
            const selectAno = document.getElementById('selectAno');
            const selectMes = document.getElementById('selectMes');
            const selectDia = document.getElementById('selectDia');
            const downloadMesModal = document.getElementById('downloadMesModal');
            const closeDownloadMes = document.getElementById('closeDownloadMes');
            const cancelDownloadMes = document.getElementById('cancelDownloadMes');
            const confirmDownloadMes = document.getElementById('confirmDownloadMes');
            const selectDownloadAno = document.getElementById('selectDownloadAno');
            const selectDownloadMes = document.getElementById('selectDownloadMes');
            const actionsBtn = document.getElementById('actionsBtn');
            const actionsMenu = document.getElementById('actionsMenu');
            const downloadTemplate = document.getElementById('downloadTemplate');
            const importExcel = document.getElementById('importExcel');
            const downloadAll = document.getElementById('downloadAll');
            const downloadPage = document.getElementById('downloadPage');
            const downloadMes = document.getElementById('downloadMes');
            const fileUpload = document.getElementById('fileUpload');

            window.showLoading = () => loading.classList.add('show');
            window.hideLoading = () => loading.classList.remove('show');

            function showImportProgress(p) {
                importProgress.classList.add('show');
                progressBar.style.width = p + '%';
                progressText.textContent = `Importando: ${Math.round(p)}%`;
            }
            function hideImportProgress() {
                importProgress.classList.remove('show');
                progressBar.style.width = '0%';
                progressText.textContent = 'Importando: 0%';
            }

            function showToast(text, type = 'success') {
                toast.textContent = text;
                toast.className = `reportes-toast ${type}`;
                toast.classList.add('show');
                setTimeout(() => toast.classList.remove('show'), 5000);
            }

            async function getReporteByUniqueKey(admision, codArticulo) {
                if (!admision || !codArticulo) return null;
                const q = query(collection(db, "reportes"), where("admision", "==", admision.trim()), where("codArticulo", "==", codArticulo.trim()));
                const snap = await getDocs(q);
                return !snap.empty ? {id: snap.docs[0].id, ...snap.docs[0].data()} : null;
            }

            function openDownloadMesModal() {
                populateAnoSelect(selectDownloadAno);
                selectDownloadAno.value = selectedAno;
                populateMesSelect(selectDownloadMes, selectDownloadAno.value);
                downloadMesModal.style.display = 'block';
            }

            closeDownloadMes.onclick = cancelDownloadMes.onclick = () => downloadMesModal.style.display = 'none';
            window.onclick = e => { if (e.target === downloadMesModal) downloadMesModal.style.display = 'none'; };

            confirmDownloadMes.onclick = async () => {
                const ano = selectDownloadAno.value;
                const mes = selectDownloadMes.value;
                if (ano && mes) {
                    showLoading();
                    const data = await getReportesByMes(ano, mes);
                    exportToExcel(data.map(r=>({
                        fecha: formatDateToDDMMYYYY(r.fecha), dia: r.dia, mes: r.mes, codArticulo: r.codArticulo,
                        descripcion: r.descripcion, admision: r.admision, rut: r.rut, paciente: r.paciente,
                        edad: r.edad, prevision: r.prevision, isapre: r.isapre, convenio: r.convenio,
                        codArancel: r.codArancel, arancel: r.arancel, cantidadArticulo: r.cantidadArticulo,
                        primerCirujano: r.primerCirujano
                    })), `reportes_${ano}_${mes}`);
                    hideLoading();
                    downloadMesModal.style.display = 'none';
                } else showToast('Selecciona año y mes', 'error');
            };

            onAuthStateChanged(auth, async user => {
                if (!user) { window.location.replace('../../../../../../index.html'); return; }
                window.currentUserData = { fullName: user.displayName || 'Usuario Invitado', username: user.email || 'invitado' };
                await loadReportes();
                populateAnoSelect(selectAno);
                selectAno.value = selectedAno;
                populateMesSelect(selectMes, selectedAno);
                populateDiaSelect(selectDia, selectedAno, selectedMes);
                initColumnResizing();
            });

            [buscarAdmisionInput, buscarPacienteInput, buscarRutInput, buscarDescripcionInput, buscarPrimerCirujanoInput].forEach(input => {
                input?.addEventListener('input', e => {
                    const val = e.target.value.trim();
                    if (input.id === 'buscarAdmision') searchAdmision = val;
                    if (input.id === 'buscarPaciente') searchPaciente = val;
                    if (input.id === 'buscarRut') searchRut = val;
                    if (input.id === 'buscarDescripcion') searchDescripcion = val;
                    if (input.id === 'buscarPrimerCirujano') searchPrimerCirujano = val;
                    currentPage = 1; renderTable();
                });
            });

            selectAno.onchange = e => { selectedAno = e.target.value; selectedMes = selectedDia = ''; populateMesSelect(selectMes, selectedAno); populateDiaSelect(selectDia, selectedAno, ''); currentPage = 1; renderTable(); };
            selectMes.onchange = e => { selectedMes = e.target.value; selectedDia = ''; populateDiaSelect(selectDia, selectedAno, selectedMes); currentPage = 1; renderTable(); };
            selectDia.onchange = () => { selectedDia = selectDia.value; currentPage = 1; renderTable(); };
            selectDownloadAno.onchange = e => populateMesSelect(selectDownloadMes, e.target.value);

            async function loadReportes() {
                showLoading();
                const snap = await getDocs(collection(db, "reportes"));
                reportes = []; anos = new Set(); mesesPorAno = {}; diasPorMesAno = {};
                snap.forEach(d => {
                    const data = d.data();
                    reportes.push({id: d.id, ...data});
                    const date = new Date(data.fecha);
                    if (!isNaN(date)) {
                        const a = date.getFullYear();
                        const m = data.mes || date.toLocaleString('es-CL', {month:'long'});
                        const dia = data.dia || date.toLocaleString('es-CL', {weekday:'long'});
                        anos.add(a);
                        mesesPorAno[a] = mesesPorAno[a] || new Set(); mesesPorAno[a].add(m);
                        diasPorMesAno[a] = diasPorMesAno[a] || {}; diasPorMesAno[a][m] = diasPorMesAno[a][m] || new Set();
                        diasPorMesAno[a][m].add(dia);
                    }
                });
                renderTable();
                hideLoading();
            }

            function populateAnoSelect(sel) {
                sel.innerHTML = '<option value="">Todos</option>';
                Array.from(anos).sort((a,b)=>b-a).forEach(a => sel.insertAdjacentHTML('beforeend', `<option value="${a}">${a}</option>`));
            }
            function populateMesSelect(sel, ano) {
                sel.innerHTML = '<option value="">Todos</option>';
                if (ano && mesesPorAno[ano]) Array.from(mesesPorAno[ano]).sort((a,b)=>new Date('01 '+a+' 2000')-new Date('01 '+b+' 2000')).forEach(m=>sel.insertAdjacentHTML('beforeend',`<option value="${m}">${m}</option>`));
            }
            function populateDiaSelect(sel, ano, mes) {
                sel.innerHTML = '<option value="">Todos</option>';
                if (ano && mes && diasPorMesAno[ano]?.[mes]) Array.from(diasPorMesAno[ano][mes]).sort().forEach(d=>sel.insertAdjacentHTML('beforeend',`<option value="${d}">${d}</option>`));
            }

            actionsBtn.onclick = () => actionsMenu.style.display = actionsMenu.style.display==='block'?'none':'block';
            window.onclick = e => { if (!actionsBtn.contains(e.target) && !actionsMenu.contains(e.target)) actionsMenu.style.display='none'; };

            downloadTemplate.onclick = e => { e.preventDefault(); downloadImportTemplate(); actionsMenu.style.display='none'; };
            importExcel.onclick = e => { e.preventDefault(); fileUpload.click(); actionsMenu.style.display='none'; };
            downloadAll.onclick = e => { e.preventDefault(); exportToExcel(reportes.map(r=>({fecha:formatDateToDDMMYYYY(r.fecha),dia:r.dia,mes:r.mes,codArticulo:r.codArticulo,descripcion:r.descripcion,admision:r.admision,rut:r.rut,paciente:r.paciente,edad:r.edad,prevision:r.prevision,isapre:r.isapre,convenio:r.convenio,codArancel:r.codArancel,arancel:r.arancel,cantidadArticulo:r.cantidadArticulo,primerCirujano:r.primerCirujano})), 'todos_reportes'); actionsMenu.style.display='none'; };
            downloadPage.onclick = e => { e.preventDefault(); const filtered = getFilteredReportes(); const start = (currentPage-1)*PAGE_SIZE; const pageData = filtered.slice(start, start+PAGE_SIZE).map(r=>({fecha:formatDateToDDMMYYYY(r.fecha),dia:r.dia,mes:r.mes,codArticulo:r.codArticulo,descripcion:r.descripcion,admision:r.admision,rut:r.rut,paciente:r.paciente,edad:r.edad,prevision:r.prevision,isapre:r.isapre,convenio:r.convenio,codArancel:r.codArancel,arancel:r.arancel,cantidadArticulo:r.cantidadArticulo,primerCirujano:r.primerCirujano})); exportToExcel(pageData, 'pagina_actual_reportes'); actionsMenu.style.display='none'; };
            downloadMes.onclick = e => { e.preventDefault(); openDownloadMesModal(); actionsMenu.style.display='none'; };

            fileUpload.onchange = async e => {
                if (e.target.files[0]) { await importFromExcel(e.target.files[0]); fileUpload.value = ''; }
            };

            function exportToExcel(data, name) {
                const ws = XLSX.utils.json_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Reportes");
                XLSX.writeFile(wb, name + '.xlsx');
            }

            function downloadImportTemplate() {
                const ws = XLSX.utils.aoa_to_sheet([["Fecha","Día","Mes","Cod. Artículo","Descripción","Admisión","Rut","Paciente","Edad","Previsión","Isapre","Convenio","Cód. Arancel","Arancel","Cant. Art.","1° Cirujano"],["01-10-2025","Lunes","Octubre","ART001","Consulta médica","ADM001","12345678-9","Juan Pérez","30","Fonasa","Isapre A","Convenio 1","ARN001","50000","1","Dr. García"]]);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Template");
                XLSX.writeFile(wb, 'template_reportes.xlsx');
            }

            async function importFromExcel(file) {
                try {
                    const data = await file.arrayBuffer();
                    const wb = XLSX.read(data, {type:'array', cellDates:true});
                    const ws = wb.Sheets[wb.SheetNames[0]];
                    const json = XLSX.utils.sheet_to_json(ws, {header:["fecha","dia","mes","codArticulo","descripcion","admision","rut","paciente","edad","prevision","isapre","convenio","codArancel","arancel","cantidadArticulo","primerCirujano"], range:1, defval:'', raw:false});
                    let added = 0, updated = 0, skipped = 0;
                    for (let i = 0; i < json.length; i++) {
                        const r = json[i];
                        const row = {
                            fecha: r.fecha ? formatDateToDDMMYYYY(new Date(r.fecha)) : '',
                            dia: String(r.dia||'').trim(),
                            mes: String(r.mes||'').trim(),
                            codArticulo: String(r.codArticulo||'').trim(),
                            descripcion: String(r.descripcion||'').trim(),
                            admision: String(r.admision||'').trim(),
                            rut: String(r.rut||'').trim(),
                            paciente: String(r.paciente||'').trim(),
                            edad: String(r.edad||'').trim(),
                            prevision: String(r.prevision||'').trim(),
                            isapre: String(r.isapre||'').trim(),
                            convenio: String(r.convenio||'').trim(),
                            codArancel: String(r.codArancel||'').trim(),
                            arancel: String(r.arancel||'').trim(),
                            cantidadArticulo: String(r.cantidadArticulo||'').trim(),
                            primerCirujano: String(r.primerCirujano||'').trim()
                        };
                        if (row.admision && row.codArticulo && row.fecha) {
                            const existing = await getReporteByUniqueKey(row.admision, row.codArticulo);
                            if (existing) {
                                const changed = Object.keys(row).some(k => row[k] !== String(existing[k]||'').trim());
                                if (changed) { await updateDoc(doc(db,"reportes",existing.id), {...row, createdAt:new Date()}); updated++; } else skipped++;
                            } else { await addDoc(collection(db,"reportes"), {...row, createdAt:new Date()}); added++; }
                        } else skipped++;
                        showImportProgress((i+1)/json.length*100);
                    }
                    hideImportProgress();
                    showToast(`Importación completa: ${added} nuevos, ${updated} actualizados, ${skipped} omitidos`, 'success');
                    await loadReportes();
                } catch(err) { hideImportProgress(); showToast('Error importando: '+err.message, 'error'); }
            }

            async function getReportesByMes(ano, mes) {
                return reportes.filter(r => new Date(r.fecha).getFullYear() == ano && new Date(r.fecha).toLocaleString('es-CL',{month:'long'}) === mes);
            }

            function getFilteredReportes() {
                return reportes.filter(r =>
                    (r.admision||'').toLowerCase().includes(searchAdmision.toLowerCase()) &&
                    (r.paciente||'').toLowerCase().includes(searchPaciente.toLowerCase()) &&
                    (r.rut||'').toLowerCase().includes(searchRut.toLowerCase()) &&
                    (r.descripcion||'').toLowerCase().includes(searchDescripcion.toLowerCase()) &&
                    (r.primerCirujano||'').toLowerCase().includes(searchPrimerCirujano.toLowerCase()) &&
                    (!selectedAno || new Date(r.fecha).getFullYear() == selectedAno) &&
                    (!selectedMes || new Date(r.fecha).toLocaleString('es-CL',{month:'long'}) === selectedMes) &&
                    (!selectedDia || (r.dia||'').toLowerCase() === selectedDia.toLowerCase())
                );
            }

            window.renderTable = function() {
                const filtered = getFilteredReportes();
                const start = (currentPage-1)*PAGE_SIZE;
                const pageData = filtered.sort((a,b)=>a.admision.localeCompare(b.admision)).slice(start, start+PAGE_SIZE);
                reportesBody.innerHTML = '';
                pageData.forEach(r => {
                    reportesBody.insertAdjacentHTML('beforeend', `<tr>
                        <td>${formatDateToDDMMYYYY(r.fecha)||''}</td>
                        <td>${r.dia||''}</td>
                        <td>${r.mes||''}</td>
                        <td>${r.codArticulo||''}</td>
                        <td>${r.descripcion||''}</td>
                        <td>${r.admision||''}</td>
                        <td>${r.rut||''}</td>
                        <td>${r.paciente||''}</td>
                        <td>${r.edad||''}</td>
                        <td>${r.prevision||''}</td>
                        <td>${r.isapre||''}</td>
                        <td>${r.convenio||''}</td>
                        <td>${r.codArancel||''}</td>
                        <td>${r.arancel||''}</td>
                        <td>${r.cantidadArticulo||''}</td>
                        <td>${r.primerCirujano||''}</td>
                    </tr>`);
                });
                updatePagination(filtered.length);
                setTimeout(() => {
                    const saved = localStorage.getItem('reportes-column-widths');
                    if (saved) {
                        try {
                            const widths = JSON.parse(saved);
                            document.querySelectorAll('#reportesTable th').forEach((th,i) => {
                                if (widths[i]) {
                                    const w = widths[i];
                                    th.style.width = th.style.minWidth = th.style.maxWidth = w+'px';
                                    document.querySelectorAll(`#reportesTable tbody td:nth-child(${i+1})`).forEach(td => {
                                        td.style.width = td.style.minWidth = td.style.maxWidth = w+'px';
                                    });
                                }
                            });
                        } catch(e) {}
                    }
                }, 10);
            };

            function updatePagination(total) {
                const totalPages = Math.ceil(total/PAGE_SIZE);
                paginationInfo.textContent = `Página ${currentPage} de ${totalPages} | ${Math.min(PAGE_SIZE, total - (currentPage-1)*PAGE_SIZE)} registros de ${total}`;
                prevBtn.disabled = currentPage === 1;
                nextBtn.disabled = currentPage === totalPages;
                pageNumbers.innerHTML = '';
                const startP = Math.max(1, currentPage-2);
                const endP = Math.min(totalPages, startP+4);
                for (let i = startP; i <= endP; i++) {
                    const btn = document.createElement('button');
                    btn.textContent = i;
                    if (i===currentPage) btn.classList.add('active');
                    btn.onclick = () => { currentPage = i; renderTable(); };
                    pageNumbers.appendChild(btn);
                }
            }

            prevBtn.onclick = () => { if (currentPage>1) { currentPage--; renderTable(); } };
            nextBtn.onclick = () => { if (currentPage < Math.ceil(getFilteredReportes().length/PAGE_SIZE)) { currentPage++; renderTable(); } };

            initColumnResizing();
        });
    </script>
</body>
</html>