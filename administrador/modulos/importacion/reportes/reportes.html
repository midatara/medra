<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Importación de Reportes</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
        import { getAuth, onAuthStateChanged, setPersistence, browserSessionPersistence } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
        import { getFirestore, collection, getDocs, addDoc, query, where, doc, updateDoc } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';
        window.firebaseModules = { initializeApp, getAuth, onAuthStateChanged, setPersistence, browserSessionPersistence, getFirestore, collection, getDocs, addDoc, query, where, doc, updateDoc };
    </script>
    <style>
        html,body{margin:0;padding:0;height:100%;font-family:Arial,sans-serif;background:#f4f4f4;overflow:hidden;font-size:12px}
        .reportes-main-container{width:100%;height:100%;background:white;padding:20px;box-sizing:border-box;display:flex;flex-direction:column;position:relative}
        .reportes-title{margin:0 0 15px 0;font-size:18px}
        .reportes-controls{display:flex;justify-content:space-between;align-items:end;gap:15px;margin-bottom:15px;flex-wrap:wrap}
        .reportes-filters{display:flex;gap:12px;flex:1;flex-wrap:wrap;align-items:end}
        .reportes-form-group{display:flex;flex-direction:column;min-width:140px}
        .reportes-label{font-size:10px;font-weight:bold;color:#333;margin-bottom:4px}
        input,select{width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;font-size:11px;box-sizing:border-box}
        input:focus,select:focus{outline:none;box-shadow:0 0 0 2px rgba(0,123,255,0.3)}
        .reportes-actions{position:relative}
        #actionsBtn{background:#007bff;color:white;border:none;padding:10px 16px;border-radius:4px;cursor:pointer;font-size:13px;display:flex;align-items:center;gap:8px}
        #actionsBtn:hover{background:#0056b3}
        .reportes-dropdown{display:none;position:absolute;right:0;top:100%;background:white;border:1px solid #ddd;border-radius:4px;box-shadow:0 6px 16px rgba(0,0,0,0.15);z-index:100;min-width:220px;margin-top:4px}
        .reportes-dropdown.show{display:block}
        .reportes-dropdown a{display:block;padding:12px 16px;font-size:12px;color:#333;text-decoration:none;border-bottom:1px solid #eee}
        .reportes-dropdown a:last-child{border-bottom:none}
        .reportes-dropdown a:hover{background:#f8f9fa}
        .table-wrapper{height:700px;overflow:auto;border:1px solid #ddd;border-radius:4px;background:white;position:relative}
        .reportes-table{width:100%;min-width:2200px;border-collapse:collapse;font-size:11px}
        .reportes-table th,.reportes-table td{padding:6px 4px;border:1px solid #ddd;text-align:left;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        .reportes-table th{background:#f2f2f2;position:relative}
        .reportes-table tbody tr:hover{background:#f8f9fa}
        .resize-handle{position:absolute;right:0;top:0;width:5px;height:100%;cursor:col-resize;background:transparent;z-index:11}
        .resize-handle:hover,.resize-handle.active{background:#007bff}
        .empty-message{text-align:center;padding:80px 0;font-size:14px;color:#666}
        .table-loading{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(255,255,255,0.95);padding:30px;border-radius:12px;box-shadow:0 4px 20px rgba(0,0,0,0.2);z-index:10;display:none;flex-direction:column;align-items:center}
        .table-loading.show{display:flex}
        .spinner-table{width:40px;height:40px;border:5px solid #f0f0f0;border-top:5px solid #007bff;border-radius:50%;animation:s 1s linear infinite;margin-bottom:12px}
        @keyframes s{to{transform:rotate(360deg)}}
        .import-loading{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.85);z-index:1000;justify-content:center;align-items:center;flex-direction:column;color:white}
        .import-loading.show{display:flex}
        .import-loading h3{margin:0 0 20px 0;font-size:18px}
        .progress-container{width:60%;max-width:500px;background:#444;border-radius:8px;overflow:hidden;height:20px;margin:15px 0}
        .progress-bar{height:100%;background:#28a745;width:0%;transition:width 0.3s ease}
        .progress-text{font-size:14px;margin-top:8px}
        .reportes-toast{position:fixed;top:20px;right:20px;padding:14px 20px;border-radius:6px;color:white;z-index:1001;font-size:13px;transform:translateX(120%);transition:all .4s;opacity:0}
        .reportes-toast.show{transform:translateX(0);opacity:1}
        .reportes-toast.success{background:#28a745}
        .reportes-toast.error{background:#dc3545}
    </style>
</head>
<body>
    <div class="reportes-main-container">
        <h1 class="reportes-title">Importación de Reportes</h1>

        <div class="reportes-controls">
            <div class="reportes-filters">
                <div class="reportes-form-group">
                    <label class="reportes-label">Año</label>
                    <select id="selectAno"></select>
                </div>
                <div class="reportes-form-group">
                    <label class="reportes-label">Mes</label>
                    <select id="selectMes"><option value="">Selecciona mes</option></select>
                </div>
                <div class="reportes-form-group">
                    <label class="reportes-label">Admisión</label>
                    <input type="text" id="buscarAdmision" placeholder="Buscar admisión">
                </div>
                <div class="reportes-form-group">
                    <label class="reportes-label">Paciente</label>
                    <input type="text" id="buscarPaciente" placeholder="Buscar paciente">
                </div>
                <div class="reportes-form-group">
                    <label class="reportes-label">Rut</label>
                    <input type="text" id="buscarRut" placeholder="Buscar rut">
                </div>
                <div class="reportes-form-group">
                    <label class="reportes-label">Descripción</label>
                    <input type="text" id="buscarDescripcion" placeholder="Buscar descripción">
                </div>
                <div class="reportes-form-group">
                    <label class="reportes-label">1° Cirujano</label>
                    <input type="text" id="buscarCirujano" placeholder="Buscar cirujano">
                </div>
            </div>

            <div class="reportes-actions">
                <button id="actionsBtn">Acciones</button>
                <div id="actionsMenu" class="reportes-dropdown">
                    <a href="#" id="downloadTemplate">Formato de importación</a>
                    <a href="#" id="importExcel">Importar Excel</a>
                    <a href="#" id="downloadVisible">Descargar visibles</a>
                    <a href="#" id="downloadAll">Descargar todos</a>
                </div>
            </div>
        </div>

        <div class="table-wrapper">
            <div id="tableLoading" class="table-loading">
                <div class="spinner-table"></div>
                <div>Cargando datos...</div>
            </div>

            <table id="reportesTable" class="reportes-table">
                <thead>
                    <tr>
                        <th>Fecha<div class="resize-handle"></div></th>
                        <th>Día<div class="resize-handle"></div></th>
                        <th>Mes<div class="resize-handle"></div></th>
                        <th>Cod. Artículo<div class="resize-handle"></div></th>
                        <th>Descripción<div class="resize-handle"></div></th>
                        <th>Admisión<div class="resize-handle"></div></th>
                        <th>Rut<div class="resize-handle"></div></th>
                        <th>Paciente<div class="resize-handle"></div></th>
                        <th>Edad<div class="resize-handle"></div></th>
                        <th>Previsión<div class="resize-handle"></div></th>
                        <th>Isapre<div class="resize-handle"></div></th>
                        <th>Convenio<div class="resize-handle"></div></th>
                        <th>Cód. Arancel<div class="resize-handle"></div></th>
                        <th>Arancel<div class="resize-handle"></div></th>
                        <th>Cant. Art.<div class="resize-handle"></div></th>
                        <th>1° Cirujano<div class="resize-handle"></div></th>
                    </tr>
                </thead>
                <tbody id="reportesBody">
                    <tr><td colspan="16" class="empty-message">Selecciona un mes para cargar los registros</td></tr>
                </tbody>
            </table>
        </div>

        <div id="importLoading" class="import-loading">
            <h3>Importando datos...</h3>
            <div class="progress-container">
                <div id="progressBar" class="progress-bar"></div>
            </div>
            <div id="progressText" class="progress-text">0% (0 de 0)</div>
        </div>

        <input type="file" id="fileUpload" style="display:none" accept=".xlsx,.xls">
        <div id="reportes-toast" class="reportes-toast"></div>
    </div>

    <script type="module">
        const { initializeApp, getAuth, onAuthStateChanged, setPersistence, browserSessionPersistence, getFirestore, collection, getDocs, addDoc, query, where, doc, updateDoc } = window.firebaseModules;
        const firebaseConfig = { apiKey: "AIzaSyD6JY7FaRqjZoN6OzbFHoIXxd-IJL3H-Ek", authDomain: "datara-salud.firebaseapp.com", projectId: "datara-salud", storageBucket: "datara-salud.firebasestorage.app", messagingSenderId: "198886910481", appId: "1:198886910481:web:abbc345203a423a6329fb0" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        setPersistence(auth, browserSessionPersistence);

        let reportes = [], selectedAno = new Date().getFullYear(), selectedMes = '';
        let searchAdmision = '', searchPaciente = '', searchRut = '', searchDesc = '', searchCirujano = '';

        const selectAno = document.getElementById('selectAno');
        const selectMes = document.getElementById('selectMes');
        const body = document.getElementById('reportesBody');
        const tableLoading = document.getElementById('tableLoading');
        const importLoading = document.getElementById('importLoading');
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        const toast = document.getElementById('reportes-toast');
        const actionsBtn = document.getElementById('actionsBtn');
        const actionsMenu = document.getElementById('actionsMenu');
        const fileInput = document.getElementById('fileUpload');

        function toDDMMYYYY(valor) {
            if (!valor && valor !== 0) return '';
            if (typeof valor === 'string') {
                const str = valor.trim();
                const m1 = str.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})$/);
                if (m1) {
                    const d = m1[1].padStart(2, '0');
                    const mm = m1[2].padStart(2, '0');
                    const y = m1[3];
                    if (parseInt(mm) >= 1 && parseInt(mm) <= 12 && parseInt(d) >= 1 && parseInt(d) <= 31) return `${d}-${mm}-${y}`;
                }
                const m2 = str.match(/^(\d{4})[\/\-](\d{1,2})[\/\-](\d{1,2})$/);
                if (m2) {
                    const y = m2[1];
                    const mm = m2[2].padStart(2, '0');
                    const d = m2[3].padStart(2, '0');
                    if (parseInt(mm) >= 1 && parseInt(mm) <= 12 && parseInt(d) >= 1 && parseInt(d) <= 31) return `${d}-${mm}-${y}`;
                }
            }
            if (typeof valor === 'number') {
                const epoch1900 = new Date(Date.UTC(1899, 11, 30));
                const fecha = new Date(epoch1900.getTime() + valor * 86400000);
                return `${String(fecha.getUTCDate()).padStart(2,'0')}-${String(fecha.getUTCMonth()+1).padStart(2,'0')}-${fecha.getUTCFullYear()}`;
            }
            if (valor instanceof Date && !isNaN(valor)) {
                return `${String(valor.getDate()).padStart(2,'0')}-${String(valor.getMonth()+1).padStart(2,'0')}-${valor.getFullYear()}`;
            }
            return '';
        }

        function showTableLoading() { tableLoading.classList.add('show'); }
        function hideTableLoading() { tableLoading.classList.remove('show'); }
        function showImportLoading() { importLoading.classList.add('show'); }
        function hideImportLoading() { importLoading.classList.remove('show'); }
        function updateProgress(c,t) { 
            const p = t>0 ? Math.round((c/t)*100) : 0; 
            progressBar.style.width = p + '%'; 
            progressText.textContent = `${p}% (${c} de ${t})`; 
        }
        function showToast(m,t='success') { 
            toast.textContent = m; 
            toast.className = `reportes-toast ${t} show`; 
            setTimeout(() => toast.classList.remove('show'), 5000); 
        }

        function initResize() {
            const table = document.getElementById('reportesTable');
            if (!table) return;
            const headers = table.querySelectorAll('th');
            let isResizing = false;
            let currentCol = -1;
            let startX = 0;
            let startWidth = 0;
            const MIN_WIDTH = 40;
            const MAX_WIDTH = 800;

            applySavedColumnWidths();

            headers.forEach((th, i) => {
                let handle = th.querySelector('.resize-handle');
                if (!handle) {
                    handle = document.createElement('div');
                    handle.className = 'resize-handle';
                    th.appendChild(handle);
                }
                handle.onmousedown = e => {
                    e.preventDefault();
                    e.stopPropagation();
                    isResizing = true;
                    currentCol = i;
                    startX = e.clientX;
                    startWidth = th.offsetWidth;
                    handle.classList.add('active');
                    document.body.style.cursor = 'col-resize';
                    document.body.style.userSelect = 'none';
                };
            });

            document.onmousemove = e => {
                if (!isResizing || currentCol === -1) return;
                let nw = Math.max(MIN_WIDTH, Math.min(MAX_WIDTH, startWidth + (e.clientX - startX)));
                const px = nw + 'px';
                headers[currentCol].style.width = headers[currentCol].style.minWidth = headers[currentCol].style.maxWidth = px;
                table.querySelectorAll(`tbody td:nth-child(${currentCol + 1})`).forEach(td => {
                    td.style.width = td.style.minWidth = td.style.maxWidth = px;
                });
            };

            document.onmouseup = () => {
                if (isResizing) {
                    isResizing = false;
                    currentCol = -1;
                    document.body.style.cursor = '';
                    document.body.style.userSelect = '';
                    table.querySelectorAll('.resize-handle.active').forEach(h => h.classList.remove('active'));
                    saveColumnWidths();
                }
            };

            const observer = new MutationObserver(() => setTimeout(applySavedColumnWidths, 50));
            observer.observe(table.querySelector('tbody'), { childList: true, subtree: true });

            const originalRender = window.render;
            window.render = function(...args) {
                originalRender.apply(this, args);
                setTimeout(applySavedColumnWidths, 50);
            };
        }

        function applySavedColumnWidths() {
            const saved = localStorage.getItem('reportes-column-widths');
            if (!saved) return;
            try {
                const widths = JSON.parse(saved);
                const table = document.getElementById('reportesTable');
                if (!table) return;
                const headers = table.querySelectorAll('th');
                headers.forEach((th, i) => {
                    if (widths[i]) {
                        const px = widths[i] + 'px';
                        th.style.width = th.style.minWidth = th.style.maxWidth = px;
                        table.querySelectorAll(`tbody td:nth-child(${i + 1})`).forEach(td => {
                            td.style.width = td.style.minWidth = td.style.maxWidth = px;
                        });
                    }
                });
            } catch(e) {}
        }

        function saveColumnWidths() {
            const table = document.getElementById('reportesTable');
            if (!table) return;
            const headers = table.querySelectorAll('th');
            const widths = Array.from(headers).map(th => parseInt(th.style.width) || th.offsetWidth);
            localStorage.setItem('reportes-column-widths', JSON.stringify(widths));
        }

        async function loadAll() {
            try {
                const snap = await getDocs(collection(db, "reportes"));
                reportes = snap.docs.map(d => ({id: d.id, ...d.data()}));
                const anos = [...new Set(reportes.map(r => {
                    const f = r.fecha || '';
                    const p = f.split('-');
                    return p.length === 3 ? parseInt(p[2]) : new Date().getFullYear();
                }))].sort((a,b)=>b-a);
                selectAno.innerHTML = anos.map(a=>`<option value="${a}">${a}</option>`).join('');
                selectAno.value = selectedAno;
                updateMeses();
            } catch(e) { showToast("Error cargando datos","error"); }
        }

        function updateMeses() {
            const meses = new Set();
            reportes.forEach(r => {
                const f = r.fecha || '';
                const p = f.split('-');
                if (p.length===3 && parseInt(p[2])==selectedAno) {
                    const m = new Date(parseInt(p[2]), parseInt(p[1])-1).toLocaleString('es-CL',{month:'long'});
                    meses.add(m);
                }
            });
            const orden = ['enero','febrero','marzo','abril','mayo','junio','julio','agosto','septiembre','octubre','noviembre','diciembre'];
            const sorted = [...meses].sort((a,b)=>orden.indexOf(a)-orden.indexOf(b));
            selectMes.innerHTML = '<option value="">Selecciona mes</option>' + sorted.map(m=>`<option value="${m}">${m.charAt(0).toUpperCase()+m.slice(1)}</option>`).join('');
            selectedMes = '';
            render();
        }

        function getVisible() {
            if (!selectedMes) return [];
            return reportes.filter(r => {
                const f = r.fecha || '';
                const p = f.split('-');
                if (p.length!==3) return false;
                const y = parseInt(p[2]);
                const m = new Date(y, parseInt(p[1])-1).toLocaleString('es-CL',{month:'long'});
                if (y != selectedAno || m !== selectedMes) return false;
                return (i=>i||true)((r.admision||'').toLowerCase().includes(searchAdmision)) &&
                       (r.paciente||'').toLowerCase().includes(searchPaciente) &&
                       (r.rut||'').toLowerCase().includes(searchRut) &&
                       (r.descripcion||'').toLowerCase().includes(searchDesc) &&
                       (r.primerCirujano||'').toLowerCase().includes(searchCirujano);
            });
        }

        function render() {
            showTableLoading();
            body.innerHTML = '';
            if (!selectedMes) {
                body.innerHTML = '<tr><td colspan="16" class="empty-message">Selecciona un mes para cargar los registros</td></tr>';
                hideTableLoading();
                return;
            }
            const data = getVisible();
            if (data.length===0) {
                body.innerHTML = '<tr><td colspan="16" class="empty-message">No hay resultados</td></tr>';
                hideTableLoading();
                return;
            }
            data.forEach(r => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${r.fecha||''}</td><td>${r.dia||''}</td><td>${r.mes||''}</td><td>${r.codArticulo||''}</td><td>${r.descripcion||''}</td><td>${r.admision||''}</td><td>${r.rut||''}</td><td>${r.paciente||''}</td><td>${r.edad||''}</td><td>${r.prevision||''}</td><td>${r.isapre||''}</td><td>${r.convenio||''}</td><td>${r.codArancel||''}</td><td>${r.arancel||''}</td><td>${r.cantidadArticulo||''}</td><td>${r.primerCirujano||''}</td>`;
                body.appendChild(tr);
            });
            setTimeout(() => { hideTableLoading(); applySavedColumnWidths(); }, 100);
        }

        fileInput.onchange = async e => {
            const file = e.target.files[0];
            if (!file) return;
            showImportLoading();
            updateProgress(0,100);
            try {
                const data = await file.arrayBuffer();
                const wb = XLSX.read(data, { type: 'array', cellDates: false, raw: true });
                const ws = wb.Sheets[wb.SheetNames[0]];
                const json = XLSX.utils.sheet_to_json(ws, {
                    header: ["fecha","dia","mes","codArticulo","descripcion","admision","rut","paciente","edad","prevision","isapre","convenio","codArancel","arancel","cantidadArticulo","primerCirujano"],
                    range: 1, defval: '', raw: true
                });

                let agregados=0, actualizados=0, omitidos=0;
                const total = json.length;

                for (let i=0; i<json.length; i++) {
                    updateProgress(i+1,total);
                    const r = json[i];
                    const fila = {
                        fecha: toDDMMYYYY(r.fecha), dia: String(r.dia||'').trim(), mes: String(r.mes||'').trim(),
                        codArticulo: String(r.codArticulo||'').trim(), descripcion: String(r.descripcion||'').trim(),
                        admision: String(r.admision||'').trim(), rut: String(r.rut||'').trim(),
                        paciente: String(r.paciente||'').trim(), edad: String(r.edad||'').trim(),
                        prevision: String(r.prevision||'').trim(), isapre: String(r.isapre||'').trim(),
                        convenio: String(r.convenio||'').trim(), codArancel: String(r.codArancel||'').trim(),
                        arancel: String(r.arancel||'').trim(), cantidadArticulo: String(r.cantidadArticulo||'').trim(),
                        primerCirujano: String(r.primerCirujano||'').trim()
                    };
                    if (!fila.admision || !fila.codArticulo) { omitidos++; continue; }

                    const q = query(collection(db,"reportes"), where("admision","==",fila.admision), where("codArticulo","==",fila.codArticulo));
                    const snap = await getDocs(q);

                    if (!snap.empty) {
                        const existente = snap.docs[0].data();
                        const cambios = Object.keys(fila).some(k=>String(fila[k])!==String(existente[k]||'').trim());
                        if (cambios) {
                            await updateDoc(doc(db,"reportes",snap.docs[0].id),{...fila, updatedAt:new Date()});
                            actualizados++;
                        } else omitidos++;
                    } else {
                        await addDoc(collection(db,"reportes"),{...fila, createdAt:new Date()});
                        agregados++;
                    }
                }
                hideImportLoading();
                showToast(`Importación completada: ${agregados} nuevos, ${actualizados} actualizados, ${omitidos} omitidos`, 'success');
                await loadAll();
            } catch(err) {
                hideImportLoading();
                showToast('Error al importar: '+err.message,'error');
            }
            fileInput.value='';
        };

        selectAno.onchange = () => { selectedAno = selectAno.value; updateMeses(); };
        selectMes.onchange = () => { selectedMes = selectMes.value; render(); };

        ['buscarAdmision','buscarPaciente','buscarRut','buscarDescripcion','buscarCirujano'].forEach(id=>{
            document.getElementById(id).oninput = e=>{
                const v = e.target.value.toLowerCase().trim();
                if(id==='buscarAdmision') searchAdmision=v;
                if(id==='buscarPaciente') searchPaciente=v;
                if(id==='buscarRut') searchRut=v;
                if(id==='buscarDescripcion') searchDesc=v;
                if(id==='buscarCirujano') searchCirujano=v;
                if(selectedMes) render();
            };
        });

        actionsBtn.onclick = e=>{ e.stopPropagation(); actionsMenu.classList.toggle('show'); };
        document.addEventListener('click', e=>{
            if(!actionsBtn.contains(e.target) && !actionsMenu.contains(e.target)) actionsMenu.classList.remove('show');
        });

        document.getElementById('downloadTemplate').onclick = e=>{ e.preventDefault(); downloadTemplate(); actionsMenu.classList.remove('show'); };
        document.getElementById('importExcel').onclick = e=>{ e.preventDefault(); fileInput.click(); actionsMenu.classList.remove('show'); };
        document.getElementById('downloadVisible').onclick = e=>{ e.preventDefault(); exportData(getVisible(),'reportes_visibles'); actionsMenu.classList.remove(('show')); };
        document.getElementById('downloadAll').onclick = e=>{ e.preventDefault(); exportData(reportes,'todos_reportes'); actionsMenu.classList.remove('show'); };

        function downloadTemplate() {
            const ws = XLSX.utils.aoa_to_sheet([["Fecha","Día","Mes","Cod. Artículo","Descripción","Admisión","Rut","Paciente","Edad","Previsión","Isapre","Convenio","Cód. Arancel","Arancel","Cant. Art.","1° Cirujano"]]);
            const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,"Template");
            XLSX.writeFile(wb,"template_reportes.xlsx");
        }

        function exportData(data,name) {
            const exp = data.map(r=>({fecha:r.fecha||'',dia:r.dia,mes:r.mes,codArticulo:r.codArticulo,descripcion:r.descripcion,admision:r.admision,rut:r.rut,paciente:r.paciente,edad:r.edad,prevision:r.prevision,isapre:r.isapre,convenio:r.convenio,codArancel:r.codArancel,arancel:r.arancel,cantidadArticulo:r.cantidadArticulo,primerCirujano:r.primerCirujano}));
            const ws = XLSX.utils.json_to_sheet(exp);
            const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,"Reportes");
            XLSX.writeFile(wb,name+'.xlsx');
        }

        onAuthStateChanged(auth, user=>{
            if(!user){ window.location.replace('../../../../../../index.html'); return; }
            loadAll().then(()=>initResize());
        });
    </script>
</body>
</html>