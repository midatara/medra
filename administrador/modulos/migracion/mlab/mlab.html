<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Migrar Ingresos Lab</title>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f0f0f0; }
    .container { max-width: 600px; margin: auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
    h1 { text-align: center; color: #1a73e8; }
    button { padding: 12px 24px; font-size: 16px; background: #1a73e8; color: white; border: none; border-radius: 6px; cursor: pointer; width: 100%; margin-top: 20px; }
    button:disabled { background: #ccc; cursor: not-allowed; }
    .log { margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 6px; height: 350px; overflow-y: auto; font-family: monospace; font-size: 13px; }
    .success { color: green; }
    .error { color: red; }
    #authSection { text-align: center; margin-bottom: 20px; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Migraci√≥n Ingresos</h1>
    
    <div id="authSection">
      <p>üë§ <strong>Estado:</strong> <span id="authStatus">No autenticado</span></p>
      <button id="loginBtn">INICIAR SESI√ìN</button>
      <p style="font-size: 12px; color: #666; margin-top: 10px;">
        Necesitas iniciar sesi√≥n con tu cuenta de Google para migrar los datos
      </p>
    </div>

    <div id="migrationSection" class="hidden">
      <p><strong>Esto copiar√° todos los datos de:</strong></p>
      <ul>
        <li><strong>ingresos_lab</strong> ‚Üí <strong>laboratorio_ingresos</strong></li>
        <li><strong>ingresos_lab_historial</strong> ‚Üí <strong>laboratorio_ingresos_historial</strong></li>
      </ul>
      <p><small>‚úÖ Se mantienen los mismos IDs. Es seguro ejecutarlo varias veces.</small></p>
      <button id="btnMigrar">INICIAR MIGRACI√ìN</button>
    </div>

    <div id="log" class="log">Listo para comenzar...</div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyD6JY7FaRqjZoN6OzbFHoIXxd-IJL3H-Ek",
      authDomain: "datara-salud.firebaseapp.com",
      projectId: "datara-salud",
      storageBucket: "datara-salud.firebasestorage.app",
      messagingSenderId: "198886910481",
      appId: "1:198886910481:web:abbc345203a423a6329fb0"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    const log = document.getElementById('log');
    const authSection = document.getElementById('authSection');
    const migrationSection = document.getElementById('migrationSection');
    const btnMigrar = document.getElementById('btnMigrar');
    const loginBtn = document.getElementById('loginBtn');
    const authStatus = document.getElementById('authStatus');

    function addLog(text, type = '') {
      const timestamp = new Date().toLocaleTimeString();
      const div = document.createElement('div');
      div.innerHTML = `<strong>[${timestamp}]</strong> ${text}`;
      if (type) div.className = type;
      log.appendChild(div);
      log.scrollTop = log.scrollHeight;
    }

    function updateAuthStatus() {
      auth.onAuthStateChanged((user) => {
        if (user) {
          authStatus.textContent = `Autenticado como: ${user.email}`;
          authSection.classList.add('hidden');
          migrationSection.classList.remove('hidden');
          addLog(`‚úÖ Autenticado como ${user.email}`, 'success');
        } else {
          authStatus.textContent = 'No autenticado';
          authSection.classList.remove('hidden');
          migrationSection.classList.add('hidden');
          addLog('‚ö†Ô∏è No est√°s autenticado. Haz clic en "INICIAR SESI√ìN"', 'error');
        }
      });
    }

    loginBtn.addEventListener('click', () => {
      addLog('Iniciando proceso de autenticaci√≥n...');
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider)
        .then((result) => {
          addLog(`‚úÖ Login exitoso: ${result.user.email}`, 'success');
          updateAuthStatus();
        })
        .catch((error) => {
          addLog(`‚ùå Error de autenticaci√≥n: ${error.message}`, 'error');
          console.error(error);
        });
    });

    async function migrarColeccion(origen, destino) {
      addLog(`üöÄ Iniciando migraci√≥n: ${origen} ‚Üí ${destino}`);
      
      try {
        const snapshot = await db.collection(origen).get();
        addLog(`üìä Encontrados ${snapshot.size} documentos en ${origen}`);

        if (snapshot.empty) {
          addLog(`‚ö†Ô∏è La colecci√≥n ${origen} est√° vac√≠a`, 'error');
          return;
        }

        let count = 0;
        const batchSize = 400; 
        let batch = db.batch();

        for (const doc of snapshot.docs) {
          const refDestino = db.collection(destino).doc(doc.id);
          batch.set(refDestino, doc.data());

          count++;
          
          if (count % 50 === 0) {
            addLog(`‚è≥ Progreso: ${count}/${snapshot.size} documentos...`);
          }

          if (count % batchSize === 0 || count === snapshot.size) {
            await batch.commit();
            addLog(`‚úÖ Commit: ${count} documentos copiados a ${destino}`);
            batch = db.batch();
          }
        }

        const verifySnapshot = await db.collection(destino).get();
        addLog(`üîç Verificaci√≥n: ${verifySnapshot.size} documentos en ${destino}`, 'success');
        
        if (verifySnapshot.size === snapshot.size) {
          addLog(`üéâ ¬°Migraci√≥n COMPLETA! ${origen} ‚Üí ${destino} (${count} docs)`, 'success');
        } else {
          addLog(`‚ö†Ô∏è Advertencia: Diferencia en conteo (${snapshot.size} vs ${verifySnapshot.size})`, 'error');
        }
      } catch (error) {
        addLog(`‚ùå ERROR en ${origen} ‚Üí ${destino}: ${error.message}`, 'error');
        console.error(error);
        throw error;
      }
    }

    btnMigrar.addEventListener('click', async () => {
      btnMigrar.disabled = true;
      btnMigrar.textContent = 'MIGRANDO...';
      addLog('=== INICIANDO MIGRACI√ìN COMPLETA ===');

      try {
        await db.collection('ingresos_lab').limit(1).get();
        addLog('‚úÖ Conexi√≥n a Firestore OK');

        await migrarColeccion('ingresos_lab', 'laboratorio_ingresos');
        await migrarColeccion('ingresos_lab_historial', 'laboratorio_ingresos_historial');

        addLog('=== üéä MIGRACI√ìN TOTAL COMPLETADA ===', 'success');
        addLog('üìù Ahora puedes cambiar los nombres en ingresos.js:', 'success');
        addLog('  "ingresos_lab" ‚Üí "laboratorio_ingresos"', 'success');
        addLog('  "ingresos_lab_historial" ‚Üí "laboratorio_ingresos_historial"', 'success');
        addLog('üîó Puedes cerrar esta p√°gina cuando termines.', 'success');
        
      } catch (err) {
        addLog(`‚ùå FALLO GENERAL: ${err.message}`, 'error');
        console.error(err);
      } finally {
        btnMigrar.disabled = false;
        btnMigrar.textContent = 'INICIAR MIGRACI√ìN';
      }
    });

    updateAuthStatus();
    addLog('üí° Abre la consola del navegador (F12) para ver detalles t√©cnicos');
  </script>
</body>
</html>